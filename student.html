<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Nandha Chatbot ‚Äî Dashboard</title>

<script src="config.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --glass: rgba(255,255,255,0.12);
    --glass-2: rgba(255,255,255,0.08);
    --accent: #0077ff;
    --accent-2: #00d4ff;
    --success: #28a745;
    --danger: #ff4d4f;
    --muted: rgba(255,255,255,0.85);
  }
  html.dark-mode { --glass: rgba(30,30,30,0.9); --glass-2: rgba(20,20,20,0.8); --accent: #00a8ff; --accent-2: #00d4ff; --muted: rgba(200,200,200,0.9); }
  html.dark-mode body { background: linear-gradient(135deg,#0a0e27,#1a1f3a); }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: "Poppins", sans-serif;
    background: linear-gradient(135deg,var(--accent),var(--accent-2));
    min-height:100vh;
    color:#fff;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    transition: background 0.3s ease;
  }

  .wrap{
    width:100%;
    max-width:1100px;
    margin:28px auto;
    padding:18px;
    display:grid;
    grid-template-columns: 360px 1fr;
    gap:18px;
  }

  /* Top controls on smaller screens collapse */
  header.topbar{
    grid-column: 1 / -1;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom:6px;
  }
  .brand{
    display:flex;
    gap:12px;
    align-items:center;
  }
  .brand h1{font-size:20px;margin:0}
  .top-actions{
    display:flex;
    gap:8px;
    align-items:center;
  }
  .icon-btn{
    background:var(--glass);
    border-radius:10px;
    width:44px;height:44px;
    display:grid;place-items:center;
    cursor:pointer;border:none;color:#fff;
    box-shadow: 0 6px 18px rgba(0,0,0,0.18);
  }

  /* LEFT COLUMN - Profile card */
  .card{
    background:var(--glass);
    padding:18px;
    border-radius:14px;
    backdrop-filter: blur(8px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
  }
  .profile-top{
    display:flex;
    gap:12px;
    align-items:center;
  }
  .avatar {
    width:84px;height:84px;border-radius:999px;
    overflow:hidden;border:3px solid rgba(255,255,255,0.12);
    background:linear-gradient(135deg,#fff2,#fff0);
    display:grid;place-items:center;font-weight:700;color:#000;
  }
  .avatar img{width:100%;height:100%;object-fit:cover;display:block}
  .avatar input{display:none}

  .profile-meta h2{margin:0;font-size:18px}
  .profile-meta p{margin:4px 0 0;font-size:13px;color:rgba(255,255,255,0.9)}
  .muted{opacity:0.9}

  .profile-actions{margin-top:12px;display:flex;gap:8px}
  .btn{padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
  .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.08);color:#fff}

  .small {font-size:13px;padding:8px 10px;border-radius:8px}

  /* Verified Badge */
  #verifiedBadge svg {
    transition: transform 0.3s ease, filter 0.3s ease;
  }
  #verifiedBadge:hover svg {
    transform: scale(1.15);
    filter: drop-shadow(0 0 6px rgba(0,102,204,0.6));
  }

  /* MIDDLE & RIGHT column */
  .right-col{
    display:grid;
    grid-template-rows: auto 1fr;
    gap:12px;
  }

  /* Status Panel (middle area) */
  .status-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
  }

  .status-card{
    background:var(--glass-2);
    padding:14px;border-radius:12px;
    min-height:86px;
  }
  .status-card h3{margin:0 0 8px;font-size:14px}
  .status-row{display:flex;justify-content:space-between;align-items:center}

  .warn-list{margin:8px 0;padding:8px;max-height:130px;overflow:auto;border-radius:8px;background:rgba(0,0,0,0.15)}

  .notice{
    background:linear-gradient(90deg,#ffd966,#ffb366);
    color:#000;padding:10px;border-radius:10px;font-weight:600;margin-bottom:8px;
  }

  /* Mailbox */
  .mailbox { background: var(--glass-2); padding: 14px; border-radius: 12px; }
  .mail-item { background: rgba(0,0,0,0.15); padding: 10px; border-radius: 10px; margin-bottom: 8px; }
  .mail-meta { font-size: 12px; opacity: 0.85; }
  .badge { display:inline-block; padding:4px 8px; border-radius: 999px; font-size: 12px; margin-left:6px; background: rgba(255,255,255,0.18); }
  .mail-actions { display:flex; gap:8px; margin-top:8px; }

  /* Chat summary and Open Chat button */
  .summary{
    display:flex;
    gap:12px;align-items:center;justify-content:space-between;
  }
  .summary .stat{background:rgba(255,255,255,0.06);padding:10px;border-radius:10px;min-width:110px;text-align:center}
  .open-chat{margin-top:12px}

  /* small helper */
  .mutedSmall { font-size:13px; opacity:0.85; color:rgba(255,255,255,0.9); }

  /* Cosmetics Modal */
  .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; justify-content:center; align-items:center; backdrop-filter:blur(8px); }
  .modal-overlay.active { display:flex; }
  .modal-content { background:linear-gradient(135deg, #1e293b, #0f172a); border-radius:20px; padding:25px; max-width:700px; width:90%; max-height:85vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.5); position:relative; }
  .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:2px solid rgba(255,255,255,0.1); padding-bottom:12px; }
  .modal-close { font-size:28px; cursor:pointer; color:#fff; line-height:1; }
  .modal-close:hover { color:#f87171; }
  .cosmetic-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:14px; margin-top:14px; }
  .cosmetic-card { background:rgba(255,255,255,0.08); border-radius:12px; padding:14px; position:relative; border:2px solid transparent; transition:all 0.3s; }
  .cosmetic-card.legendary { border-color:#fbbf24; background:linear-gradient(135deg, rgba(251,191,36,0.15), rgba(217,119,6,0.15)); }
  .cosmetic-card.eternal { border-color:#a78bfa; background:linear-gradient(135deg, rgba(167,139,250,0.15), rgba(139,92,246,0.15)); box-shadow:0 0 20px rgba(167,139,250,0.3); }
  .cosmetic-card.rare { border-color:#60a5fa; }
  .cosmetic-card.mythic { border-color:#22d3ee; border-width:3px; background:linear-gradient(135deg, rgba(34,211,238,0.25), rgba(14,165,233,0.2)); box-shadow:0 0 30px rgba(34,211,238,0.5), 0 0 60px rgba(34,211,238,0.2); animation:mythic-card-glow 3s infinite; }
  .cosmetic-card.transcendent { border-color:#7c3aed; border-width:4px; background:linear-gradient(135deg, rgba(124,58,237,0.3), rgba(67,56,202,0.25)); box-shadow:0 0 40px rgba(124,58,237,0.7), 0 0 80px rgba(124,58,237,0.4), 0 0 120px rgba(124,58,237,0.2); animation:transcendent-card-glow 2.5s infinite; }
  .cosmetic-card.supreme { border-color:#ff6b9d; border-width:5px; background:linear-gradient(135deg, rgba(255,107,157,0.4), rgba(255,20,147,0.3)); box-shadow:0 0 50px rgba(255,107,157,1), 0 0 100px rgba(255,107,157,0.6), 0 0 150px rgba(255,107,157,0.3); animation:supreme-card-glow 2s infinite; }
  .cosmetic-card.ascended { border-color:#00d4ff; border-width:6px; background:linear-gradient(135deg, rgba(0,212,255,0.5), rgba(0,255,255,0.4)); box-shadow:0 0 70px rgba(0,212,255,1), 0 0 140px rgba(0,255,255,0.8), 0 0 210px rgba(0,212,255,0.5), inset 0 0 30px rgba(0,212,255,0.3); animation:ascended-card-glow 1.5s infinite; }
  @keyframes mythic-card-glow { 0%, 100% { box-shadow:0 0 30px rgba(34,211,238,0.5), 0 0 60px rgba(34,211,238,0.2); } 50% { box-shadow:0 0 45px rgba(34,211,238,0.8), 0 0 90px rgba(34,211,238,0.4); } }
  @keyframes transcendent-card-glow { 0%, 100% { box-shadow:0 0 40px rgba(124,58,237,0.7), 0 0 80px rgba(124,58,237,0.4), 0 0 120px rgba(124,58,237,0.2); } 50% { box-shadow:0 0 60px rgba(124,58,237,1), 0 0 120px rgba(124,58,237,0.6), 0 0 180px rgba(124,58,237,0.3); } }
  @keyframes supreme-card-glow { 0%, 100% { box-shadow:0 0 50px rgba(255,107,157,1), 0 0 100px rgba(255,107,157,0.6), 0 0 150px rgba(255,107,157,0.3); } 50% { box-shadow:0 0 70px rgba(255,107,157,1), 0 0 140px rgba(255,107,157,0.8), 0 0 210px rgba(255,107,157,0.5); } }
  @keyframes ascended-card-glow { 0%, 100% { box-shadow:0 0 70px rgba(0,212,255,1), 0 0 140px rgba(0,255,255,0.8), 0 0 210px rgba(0,212,255,0.5), inset 0 0 30px rgba(0,212,255,0.3); } 50% { box-shadow:0 0 100px rgba(0,212,255,1), 0 0 200px rgba(0,255,255,1), 0 0 300px rgba(0,212,255,0.7), inset 0 0 50px rgba(0,212,255,0.5); } }
  .cosmetic-card.equipped { border-color:#10b981; box-shadow:0 0 15px rgba(16,185,129,0.4); }
  .cosmetic-card h4 { margin:0 0 8px; font-size:15px; display:flex; align-items:center; gap:6px; }
  .tier-badge { display:inline-block; padding:3px 8px; border-radius:999px; font-size:11px; font-weight:700; text-transform:uppercase; }
  .tier-badge.legendary { background:#fbbf24; color:#000; }
  .tier-badge.eternal { background:#a78bfa; color:#000; animation:eternal-glow 2s infinite; }
  .tier-badge.rare { background:#60a5fa; color:#000; }
  .tier-badge.mythic { background:linear-gradient(135deg,#22d3ee,#06b6d4); color:#000; animation:mythic-pulse 1.8s infinite; font-weight:900; }
  .tier-badge.transcendent { background:linear-gradient(135deg,#7c3aed,#5b21b6); color:#fff; animation:transcendent-glow 1.5s infinite; font-weight:900; text-shadow:0 0 8px rgba(255,255,255,0.8); }
  .tier-badge.supreme { background:linear-gradient(135deg,#ff6b9d,#ff1493); color:#fff; animation:supreme-glow 1.2s infinite; font-weight:900; text-shadow:0 0 10px rgba(255,20,147,0.9); }
  .tier-badge.ascended { background:linear-gradient(135deg,#00d4ff,#00ffff); color:#000; animation:ascended-glow 1s infinite; font-weight:900; text-shadow:0 0 10px rgba(0,212,255,1); }
  @keyframes eternal-glow { 0%, 100% { box-shadow:0 0 10px rgba(167,139,250,0.8); } 50% { box-shadow:0 0 20px rgba(167,139,250,1); } }
  @keyframes mythic-pulse { 0%, 100% { box-shadow:0 0 15px rgba(34,211,238,1), 0 0 30px rgba(34,211,238,0.6); transform:scale(1); } 50% { box-shadow:0 0 25px rgba(34,211,238,1), 0 0 50px rgba(34,211,238,0.8); transform:scale(1.05); } }
  @keyframes transcendent-glow { 0%, 100% { box-shadow:0 0 20px rgba(124,58,237,1), 0 0 40px rgba(124,58,237,0.8); transform:scale(1) rotate(0deg); } 50% { box-shadow:0 0 35px rgba(124,58,237,1), 0 0 70px rgba(124,58,237,1), 0 0 100px rgba(124,58,237,0.6); transform:scale(1.08) rotate(2deg); } }
  @keyframes supreme-glow { 0%, 100% { box-shadow:0 0 20px rgba(255,107,157,1), 0 0 40px rgba(255,107,157,0.8); transform:scale(1) rotate(0deg); } 50% { box-shadow:0 0 40px rgba(255,107,157,1), 0 0 80px rgba(255,107,157,1), 0 0 120px rgba(255,107,157,0.8); transform:scale(1.1) rotate(-3deg); } }
  @keyframes ascended-glow { 0%, 100% { box-shadow:0 0 25px rgba(0,212,255,1), 0 0 50px rgba(0,255,255,0.8); transform:scale(1) rotate(0deg); } 50% { box-shadow:0 0 50px rgba(0,212,255,1), 0 0 100px rgba(0,255,255,1), 0 0 150px rgba(0,212,255,0.8); transform:scale(1.12) rotate(4deg); } }
  .cosmetic-preview { margin:10px 0; padding:10px; border-radius:8px; background:rgba(0,0,0,0.2); text-align:center; font-size:13px; }
  .equip-btn { width:100%; padding:10px; border:none; border-radius:8px; font-weight:600; cursor:pointer; background:#3b82f6; color:#fff; margin-top:8px; transition:0.3s; }
  .equip-btn:hover { background:#60a5fa; transform:translateY(-2px); }
  .equip-btn.equipped { background:#10b981; cursor:default; }
  .equip-btn:disabled { background:#6b7280; cursor:not-allowed; }
  .lock-overlay { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); border-radius:12px; display:flex; justify-content:center; align-items:center; font-size:32px; }

  /* Responsive */
  @media (max-width:980px){
    .wrap{grid-template-columns: 1fr; padding:12px}
    .status-grid{grid-template-columns: 1fr}
    .right-col{grid-auto-rows:auto}
    header.topbar{flex-direction:column;align-items:flex-start;gap:8px}
    .cosmetic-grid { grid-template-columns:1fr; }
  }
</style>
</head>

<body>
  <div class="wrap" id="app">
    <header class="topbar">
      <div class="brand">
        <img src="" alt="" style="width:44px;height:44px;border-radius:8px;object-fit:cover;display:none" id="collegeLogo">
        <h1>Nandha Chatbot</h1>
      </div>
      <div class="top-actions">
        <div title="Toggle Dark Mode" class="icon-btn" id="darkModeToggle">üåô</div>
        <div title="Refresh Data" class="icon-btn" id="refreshDataBtn">üîÑ</div>
        <div title="Export Data" class="icon-btn" id="exportBtn">üì•</div>
        <div title="Settings" class="icon-btn" id="settingsBtn">‚öôÔ∏è</div>
        <div title="Logout" class="icon-btn" id="logoutBtn">‚éã</div>
      </div>
    </header>

    <!-- LEFT: profile card -->
    <aside>
      <div class="card" id="profileCard">
        <div class="profile-top">
          <label class="avatar" id="avatarBtn" title="Change profile picture">
            <img id="avatarImg" src="" alt="avatar" />
            <input type="file" id="avatarFile" accept="image/*" />
          </label>

          <div class="profile-meta">
            <h2 id="displayName">Loading...</h2>
            <p id="displayEmail" class="muted">email@example.com</p>
            <div id="verifiedBadge" style="margin-top:4px;display:none;">
              <svg width="20" height="20" viewBox="0 0 24 24" style="display:inline-block;vertical-align:middle;margin-left:4px;margin-bottom:2px;">
                <circle cx="12" cy="12" r="11" fill="#fff" stroke="#0f172a" stroke-width="1.5" />
                <path d="M8.5 12.5l2.2 2.2 4.8-5.4" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
              </svg>
            </div>
            <p id="displayRoll" class="muted mutedSmall" style="font-size:13px">Roll: ‚Äî</p>
            <p id="displayDept" class="muted mutedSmall" style="font-size:13px">Dept: ‚Äî</p>
          </div>
        </div>

        <div class="profile-actions">
          <button class="btn primary" id="editProfileBtn">Edit Profile</button>
          <button class="btn ghost small" id="openChatBtn">Open Chat</button>
          <button class="btn ghost small" onclick="openCosmeticsModal()" style="background:linear-gradient(135deg,#a78bfa,#8b5cf6);color:#fff;">‚ú® Cosmetics</button>
          <button class="btn ghost small" onclick="openShopModal()" style="background:linear-gradient(135deg,#22d3ee,#06b6d4);color:#000;font-weight:600;">üõçÔ∏è HC Shop</button>
          <button class="btn ghost small" onclick="openRedeemCodeModal()" style="background:linear-gradient(135deg,#34d399,#10b981);color:#000;font-weight:600;">üéüÔ∏è Redeem Code</button>
        </div>

        <!-- Virtual Pet Display -->
        <div id="petContainer" style="margin-top:16px;padding:14px;background:rgba(0,0,0,0.2);border-radius:12px;border-left:4px solid #22d3ee;display:none;">
          <div style="font-size:13px;color:#22d3ee;font-weight:600;margin-bottom:8px;">üêâ Your Pet</div>
          <div id="petGreeting" style="font-size:14px;font-weight:500;margin-bottom:8px;min-height:20px;">Hello! üëã</div>
          <div id="petAvatar" style="font-size:64px;text-align:center;margin:8px 0;line-height:1;">üêâ</div>
          <div id="petName" style="text-align:center;font-size:12px;color:rgba(255,255,255,0.9);margin-top:6px;">Dragon Companion</div>
        </div>

        <div style="margin-top:12px;font-size:13px;color:rgba(255,255,255,0.9)">
          <div>Last login: <span id="lastLogin">‚Äî</span></div>
          <div>Profile completeness: <strong id="profilePct">‚Äî</strong></div>
        </div>

        <div style="margin-top:14px;">
          <h4 style="margin:6px 0 8px 0;">My QR</h4>
          <div id="studentQR" style="background:#fff;padding:8px;border-radius:10px;display:inline-block;">
            <div id="studentQRContainer" style="width:140px;height:140px;"></div>
          </div>
          <div style="font-size:12px;opacity:0.9;margin-top:6px;">Scan to verify identity in admin panel</div>
        </div>
      </div>
    </aside>

    <!-- RIGHT: middle area (status panels) -->
    <main class="right-col">

      <!-- top row: warnings & lock -->
      <div class="status-grid">
        <div class="status-card" id="warningsCard">
          <h3>Warnings</h3>
          <div id="warningsContainer" class="warn-list">
            <!-- dynamic list -->
            <div id="noWarnings" class="muted">Loading warnings‚Ä¶</div>
          </div>
        </div>

        <div class="status-card" id="accountLockCard">
          <h3>üîê Account Lock Status</h3>
          <div id="accountLockStatus" class="status-row">
            <div><strong id="accountLockState">Loading‚Ä¶</strong></div>
            <div id="accountLockReason" class="muted" style="font-size:13px"></div>
          </div>
          <div style="margin-top:10px" id="accountLockMeta"></div>
        </div>

        <div class="status-card" id="chatbotLockCard">
          <h3>üí¨ Chatbot Access Status</h3>
          <div id="chatbotLockStatus" class="status-row">
            <div><strong id="chatbotLockState">Loading‚Ä¶</strong></div>
            <div id="chatbotLockReason" class="muted" style="font-size:13px"></div>
          </div>
          <div style="margin-top:10px" id="chatbotLockMeta"></div>
        </div>
      </div>

      <!-- second row: notices + summary + open chat -->
      <div style="display:flex;gap:12px;flex-direction:column">
        <div class="status-card" id="noticesCard">
          <h3>Notices</h3>
          <div id="noticesList" class="muted">Loading notices‚Ä¶</div>
        </div>

        <div class="status-card mailbox" id="mailboxCard">
          <h3>Mailbox</h3>
          <div class="mutedSmall">System messages, rewards and important updates from admin.</div>
          <div id="mailList" style="margin-top:8px">Loading messages‚Ä¶</div>
        </div>

        <div class="status-card" id="achievementsCard">
          <h3>üèÜ Achievements</h3>
          <div id="achievementsList" class="muted">Loading achievements‚Ä¶</div>
        </div>
          <div class="status-card" id="loginRewardsCard">
            <h3>üìÖ Daily Login Rewards (Day <span id="currentDay">1</span>/7)</h3>
            <div id="loginRewardsList" style="display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-bottom:12px;"></div>
            <button class="btn primary" onclick="claimDailyReward()" style="width:100%;" id="claimRewardBtn">üéâ Claim Today's Reward</button>
          </div>

          <div class="status-card" id="studentAppealCard">
            <h3>üìù Appeal / Report Issue</h3>
            <button class="btn primary" onclick="openStudentAppealModal()" style="width:100%; margin-bottom:10px;">üì© Send Message</button>
            <div id="studentMessagesList" class="muted" style="font-size:12px;">No messages sent yet</div>
          </div>

        <div class="status-card">
          <h3>Chat Usage Summary</h3>
          <div class="summary">
            <div class="stat">
              <div style="font-size:22px" id="totalChats">‚Äî</div>
              <div style="font-size:12px;opacity:0.9">Total Chats</div>
            </div>
            <div class="stat">
              <div style="font-size:22px" id="weeklyChats">‚Äî</div>
              <div style="font-size:12px;opacity:0.9">This Week</div>
            </div>
            <div class="stat">
              <div style="font-size:22px" id="lastChat">‚Äî</div>
              <div style="font-size:12px;opacity:0.9">Last Chat</div>
            </div>
          </div>

          <div class="open-chat">
            <button class="btn primary" id="openChatBtn2">Open Chat</button>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- Optional: socket.io client (will try to connect for realtime updates) -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
  // ---------- CONFIG ----------
  const API = "https://smart-chatbot-backend-w5tq.onrender.com"; // backend base URL

  // Accept whichever key the other pages might set (index.html used localStorage.setItem("token", ...))
  function readStoredToken() {
    return localStorage.getItem('token') ||
           localStorage.getItem('accessToken') ||
           localStorage.getItem('authToken') ||
           sessionStorage.getItem('token') ||
           sessionStorage.getItem('accessToken') ||
           sessionStorage.getItem('authToken') || null;
  }

  const token = readStoredToken();
  if (!token) {
    setTimeout(()=> location.href = 'index.html', 200);
    throw new Error('Not authenticated');
  }
  let currentProfile = null;

  function parseJwt(t) {
    try {
      const p = t.split('.')[1];
      const json = atob(p.replace(/-/g, '+').replace(/_/g, '/'));
      return JSON.parse(decodeURIComponent(escape(json)));
    } catch (e) { 
      try { return JSON.parse(atob(t.split('.')[1])); } catch { return null; }
    }
  }
  const jwtPayload = parseJwt(token);
  const userRoll = jwtPayload?.sub || jwtPayload?.roll || jwtPayload?.username || null;
  
  let csrfToken = "";
  let isCSRFLoaded = false;
  
  function getRefreshToken() {
    return localStorage.getItem('refreshToken') || sessionStorage.getItem('refreshToken') || null;
  }
  
  // Global fetch wrapper to auto-refresh on 401
  (function(){
    const originalFetch = window.fetch;
    window.fetch = async function(input, init = {}) {
      let response = await originalFetch(input, init);
      if (response && response.status === 401) {
        const rt = getRefreshToken();
        if (rt) {
          try {
            if (!isCSRFLoaded) await loadCSRF();
            const refreshRes = await originalFetch(`${API}/api/auth/refresh`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'x-csrf-token': csrfToken },
              credentials: 'include',
              body: JSON.stringify({ refreshToken: rt })
            });
            if (refreshRes.ok) {
              const data = await refreshRes.json();
              const newAccess = data.accessToken;
              const newRefresh = data.refreshToken;
              if (newAccess) {
                localStorage.setItem('token', newAccess);
                sessionStorage.setItem('token', newAccess);
              }
              if (newRefresh) {
                localStorage.setItem('refreshToken', newRefresh);
                sessionStorage.setItem('refreshToken', newRefresh);
              }
              // Update Authorization header for retry
              if (init.headers) {
                if (init.headers instanceof Headers) {
                  init.headers.set('Authorization', 'Bearer ' + newAccess);
                  init.headers.set('x-csrf-token', csrfToken);
                } else {
                  init.headers['Authorization'] = 'Bearer ' + newAccess;
                  init.headers['x-csrf-token'] = csrfToken;
                }
              }
              // Retry once
              response = await originalFetch(input, init);
            }
          } catch (e) {
            console.warn('Auto-refresh failed:', e);
          }
        }
      }
      return response;
    };
  })();
  
  // Load CSRF token
  async function loadCSRF() {
    try {
      const res = await fetch(`${API}/api/csrf-token`, { method: "GET", credentials: "include" });
      const data = await res.json();
      csrfToken = data.csrfToken || "";
      isCSRFLoaded = true;
      console.log('CSRF token loaded:', csrfToken ? 'OK' : 'EMPTY');
    } catch (e) {
      console.error("CSRF token fetch failed:", e);
    }
  }

  function authHeaders() {
    const currentToken = readStoredToken();
    const headers = { 'Authorization': 'Bearer ' + currentToken, 'Content-Type': 'application/json' };
    if (csrfToken) {
      headers['x-csrf-token'] = csrfToken;
    }
    return headers;
  }

  // ---------- DOM ----------
  const displayName = document.getElementById('displayName');
  const displayEmail = document.getElementById('displayEmail');
  const displayRoll = document.getElementById('displayRoll');
  const displayDept = document.getElementById('displayDept');
  const avatarImg = document.getElementById('avatarImg');
  const avatarFile = document.getElementById('avatarFile');
  const avatarBtn = document.getElementById('avatarBtn');
  const editProfileBtn = document.getElementById('editProfileBtn');
  const openChatBtn = document.getElementById('openChatBtn');
  const openChatBtn2 = document.getElementById('openChatBtn2');
  const logoutBtn = document.getElementById('logoutBtn');
  const settingsBtn = document.getElementById('settingsBtn');

  const warningsContainer = document.getElementById('warningsContainer');
  const accountLockState = document.getElementById('accountLockState');
  const accountLockReason = document.getElementById('accountLockReason');
  const accountLockMeta = document.getElementById('accountLockMeta');
  const chatbotLockState = document.getElementById('chatbotLockState');
  const chatbotLockReason = document.getElementById('chatbotLockReason');
  const chatbotLockMeta = document.getElementById('chatbotLockMeta');
  const noticesList = document.getElementById('noticesList');
  const mailList = document.getElementById('mailList');
  const achievementsList = document.getElementById('achievementsList');
  const loginRewardsList = document.getElementById('loginRewardsList');
  const currentDayEl = document.getElementById('currentDay');
  const claimRewardBtn = document.getElementById('claimRewardBtn');
  const studentMessagesList = document.getElementById('studentMessagesList');

  const totalChatsEl = document.getElementById('totalChats');
  const weeklyChatsEl = document.getElementById('weeklyChats');
  const lastChatEl = document.getElementById('lastChat');
  const lastLoginEl = document.getElementById('lastLogin');
  const profilePct = document.getElementById('profilePct');

  function safeSet(el, text) { if (el) el.textContent = text ?? '‚Äî'; }
  
  function svgInitialsDataUrl(initials) {
    const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'>
      <rect fill='%23ffffff' width='100%' height='100%' rx='100'/>
      <text x='50%' y='54%' font-size='72' text-anchor='middle' fill='%23000' font-family='Poppins'>${initials}</text>
    </svg>`;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
  }

  function showLocalAvatar() {
    const stored = localStorage.getItem('avatarData');
    if (stored) {
      avatarImg.src = stored;
    } else {
      const initials = (displayName.textContent || 'U').split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase();
      avatarImg.src = svgInitialsDataUrl(initials);
    }
  }

  avatarImg.addEventListener('error', () => { showLocalAvatar(); });

  function applyCosmetics(settings){
    try{
      const cos = (settings && settings.cosmetics) || {};
      // Background
      if (cos.backgroundUrl) {
        document.body.style.backgroundImage = `url('${cos.backgroundUrl}')`;
        document.body.style.backgroundSize = 'cover';
        document.body.style.backgroundPosition = 'center';
      }
      // Avatar border
      const av = document.querySelector('.avatar');
      if (av) {
        av.style.boxShadow = '';
        av.style.border = '';
        av.style.animation = '';
        
        // Rare borders
        if (cos.avatarBorder === 'glow-blue') {
          av.style.boxShadow = '0 0 12px rgba(59,130,246,0.8), 0 0 28px rgba(59,130,246,0.4)';
          av.style.border = '2px solid rgba(59,130,246,0.7)';
        } else if (cos.avatarBorder === 'gold') {
          av.style.boxShadow = '0 0 14px rgba(234,179,8,0.8)';
          av.style.border = '2px solid #f59e0b';
        } else if (cos.avatarBorder === 'neon-pink') {
          av.style.boxShadow = '0 0 14px rgba(236,72,153,0.9)';
          av.style.border = '2px solid #ec4899';
        }
        // Legendary borders
        else if (cos.avatarBorder === 'dragon-fire') {
          av.style.boxShadow = '0 0 20px rgba(251,191,36,1), 0 0 40px rgba(234,179,8,0.8)';
          av.style.border = '3px solid #fbbf24';
        }
        // Eternal borders
        else if (cos.avatarBorder === 'celestial-aura') {
          av.style.boxShadow = '0 0 25px rgba(167,139,250,1), 0 0 50px rgba(139,92,246,0.8)';
          av.style.border = '3px solid #a78bfa';
        }
        // MYTHIC borders - Enhanced power
        else if (cos.avatarBorder === 'starlight-veil') {
          av.style.boxShadow = '0 0 30px rgba(34,211,238,1), 0 0 60px rgba(34,211,238,0.8), 0 0 90px rgba(34,211,238,0.5)';
          av.style.border = '4px solid #22d3ee';
          av.style.animation = 'mythic-avatar-glow 2s infinite';
        } else if (cos.avatarBorder === 'azure-phoenix') {
          av.style.boxShadow = '0 0 35px rgba(6,182,212,1), 0 0 70px rgba(34,211,238,0.9)';
          av.style.border = '4px solid #06b6d4';
          av.style.animation = 'mythic-avatar-glow 2s infinite';
        } else if (cos.avatarBorder === 'crystal-fortress') {
          av.style.boxShadow = '0 0 32px rgba(8,145,178,1), 0 0 64px rgba(34,211,238,0.7)';
          av.style.border = '4px solid #0891b2';
          av.style.animation = 'mythic-avatar-glow 2s infinite';
        }
        // TRANSCENDENT borders - Ultimate power
        else if (cos.avatarBorder === 'prismatic-shield') {
          av.style.boxShadow = '0 0 40px rgba(124,58,237,1), 0 0 80px rgba(124,58,237,1), 0 0 120px rgba(124,58,237,0.8)';
          av.style.border = '5px solid #7c3aed';
          av.style.animation = 'transcendent-avatar-glow 2s infinite';
        } else if (cos.avatarBorder === 'eternal-flames') {
          av.style.boxShadow = '0 0 45px rgba(91,33,182,1), 0 0 90px rgba(124,58,237,1), 0 0 135px rgba(124,58,237,0.8)';
          av.style.border = '5px solid #5b21b6';
          av.style.animation = 'transcendent-avatar-glow 2s infinite';
        } else if (cos.avatarBorder === 'void-emperor') {
          av.style.boxShadow = '0 0 50px rgba(76,29,149,1), 0 0 100px rgba(124,58,237,1), 0 0 150px rgba(124,58,237,0.9)';
          av.style.border = '5px solid #4c1d95';
          av.style.animation = 'transcendent-avatar-glow 2s infinite';
        }
        
        // Animated borders (can stack with static borders)
        if (cos.animatedBorder === 'pulse-glow') {
          av.style.animation = 'cosmetic-pulse 1.5s infinite';
        } else if (cos.animatedBorder === 'rainbow-spin') {
          av.style.animation = 'cosmetic-spin 3s infinite';
        } else if (cos.animatedBorder === 'lightning-strike') {
          av.style.animation = 'cosmetic-pulse 0.8s infinite';
        } else if (cos.animatedBorder === 'quantum-field') {
          av.style.animation = 'cosmetic-spin 2s infinite';
        }
        // MYTHIC animated borders
        else if (cos.animatedBorder === 'nebula-surge') {
          av.style.animation = 'mythic-avatar-glow 1.8s infinite';
        } else if (cos.animatedBorder === 'plasma-ring') {
          av.style.animation = 'mythic-avatar-glow 1.5s infinite';
        } else if (cos.animatedBorder === 'crystal-orbit') {
          av.style.animation = 'mythic-avatar-glow 2s infinite';
        }
        // TRANSCENDENT animated borders
        else if (cos.animatedBorder === 'singularity') {
          av.style.animation = 'transcendent-avatar-glow 1.5s infinite';
        } else if (cos.animatedBorder === 'supernova') {
          av.style.animation = 'transcendent-avatar-glow 1.2s infinite';
        } else if (cos.animatedBorder === 'universe-edge') {
          av.style.animation = 'transcendent-avatar-glow 1.8s infinite';
        }
      }
      // Name style
      if (displayName) {
        displayName.style.textShadow = '';
        displayName.style.background = '';
        displayName.style.webkitBackgroundClip = '';
        displayName.style.backgroundClip = '';
        displayName.style.color = '';
        displayName.style.animation = '';
        
        // Rare styles
        if (cos.nameStyle === 'gradient-gold') {
          displayName.style.background = 'linear-gradient(90deg,#f59e0b,#fde68a)';
          displayName.style.webkitBackgroundClip = 'text';
          displayName.style.backgroundClip = 'text';
          displayName.style.color = 'transparent';
        } else if (cos.nameStyle === 'neon') {
          displayName.style.textShadow = '0 0 6px rgba(59,130,246,0.9), 0 0 12px rgba(59,130,246,0.6)';
        }
        // Legendary styles
        else if (cos.nameStyle === 'diamond-shine') {
          displayName.style.background = 'linear-gradient(90deg,#fbbf24,#fde68a,#fbbf24)';
          displayName.style.webkitBackgroundClip = 'text';
          displayName.style.backgroundClip = 'text';
          displayName.style.color = 'transparent';
          displayName.style.textShadow = '0 0 10px rgba(251,191,36,0.8)';
        }
        // Eternal styles
        else if (cos.nameStyle === 'cosmic-energy') {
          displayName.style.background = 'linear-gradient(90deg,#a78bfa,#c4b5fd,#a78bfa)';
          displayName.style.webkitBackgroundClip = 'text';
          displayName.style.backgroundClip = 'text';
          displayName.style.color = 'transparent';
          displayName.style.textShadow = '0 0 12px rgba(167,139,250,0.9)';
        }
        // MYTHIC styles - Enhanced power
        else if (cos.nameStyle === 'starlight-flare') {
          displayName.style.background = 'linear-gradient(90deg,#22d3ee,#06b6d4,#22d3ee)';
          displayName.style.webkitBackgroundClip = 'text';
          displayName.style.backgroundClip = 'text';
          displayName.style.color = 'transparent';
          displayName.style.animation = 'mythic-name-effect 2s infinite';
        } else if (cos.nameStyle === 'plasma-core') {
          displayName.style.background = 'linear-gradient(90deg,#06b6d4,#0891b2,#06b6d4)';
          displayName.style.webkitBackgroundClip = 'text';
          displayName.style.backgroundClip = 'text';
          displayName.style.color = 'transparent';
          displayName.style.animation = 'mythic-name-effect 2s infinite';
        } else if (cos.nameStyle === 'crystal-radiance') {
          displayName.style.background = 'linear-gradient(90deg,#0891b2,#22d3ee,#0891b2)';
          displayName.style.webkitBackgroundClip = 'text';
          displayName.style.backgroundClip = 'text';
          displayName.style.color = 'transparent';
          displayName.style.animation = 'mythic-name-effect 2s infinite';
        }
        // TRANSCENDENT styles - Ultimate power
        else if (cos.nameStyle === 'aurora-burst') {
          displayName.style.background = 'linear-gradient(90deg,#7c3aed,#5b21b6,#7c3aed)';
          displayName.style.webkitBackgroundClip = 'text';
          displayName.style.backgroundClip = 'text';
          displayName.style.color = 'transparent';
          displayName.style.animation = 'transcendent-name-effect 2s infinite';
        } else if (cos.nameStyle === 'divine-script') {
          displayName.style.background = 'linear-gradient(90deg,#5b21b6,#4c1d95,#5b21b6)';
          displayName.style.webkitBackgroundClip = 'text';
          displayName.style.backgroundClip = 'text';
          displayName.style.color = 'transparent';
          displayName.style.animation = 'transcendent-name-effect 2s infinite';
        } else if (cos.nameStyle === 'reality-bender') {
          displayName.style.background = 'linear-gradient(90deg,#4c1d95,#7c3aed,#4c1d95)';
          displayName.style.webkitBackgroundClip = 'text';
          displayName.style.backgroundClip = 'text';
          displayName.style.color = 'transparent';
          displayName.style.animation = 'transcendent-name-effect 2s infinite';
        }
        
        // Animated name effects
        if (cos.animatedNameEffect === 'rainbow-wave') {
          displayName.style.animation = 'cosmetic-rainbow 2s infinite';
        } else if (cos.animatedNameEffect === 'shimmer') {
          displayName.style.animation = 'cosmetic-shimmer 1.5s infinite';
        } else if (cos.animatedNameEffect === 'phoenix-blaze') {
          displayName.style.animation = 'cosmetic-rainbow 1.5s infinite';
        } else if (cos.animatedNameEffect === 'void-pulse') {
          displayName.style.animation = 'cosmetic-shimmer 1.2s infinite';
        }
        // MYTHIC animated effects
        else if (cos.animatedNameEffect === 'stardust-flow') {
          displayName.style.animation = 'mythic-name-effect 1.8s infinite';
        } else if (cos.animatedNameEffect === 'cosmic-storm') {
          displayName.style.animation = 'mythic-name-effect 1.5s infinite';
        } else if (cos.animatedNameEffect === 'crystal-cascade') {
          displayName.style.animation = 'mythic-name-effect 2s infinite';
        }
        // TRANSCENDENT animated effects
        else if (cos.animatedNameEffect === 'time-warp') {
          displayName.style.animation = 'transcendent-name-effect 2s infinite';
        } else if (cos.animatedNameEffect === 'dimension-rift') {
          displayName.style.animation = 'transcendent-name-effect 1.8s infinite';
        } else if (cos.animatedNameEffect === 'infinity-spiral') {
          displayName.style.animation = 'transcendent-name-effect 1.5s infinite';
        }
      }
      // Badges under name
      const meta = displayName?.parentElement;
      if (meta) {
        let badgeBar = meta.querySelector('.badge-bar');
        if (!badgeBar){
          badgeBar = document.createElement('div');
          badgeBar.className = 'badge-bar';
          badgeBar.style.marginTop = '6px';
          meta.appendChild(badgeBar);
        }
        badgeBar.innerHTML = '';
        const badges = (cos.badges || []).slice(0,3);
        badges.forEach(b => {
          const pill = document.createElement('span');
          pill.textContent = b;
          pill.style.cssText = 'display:inline-block;background:rgba(255,255,255,0.15);padding:4px 8px;border-radius:999px;font-size:11px;margin-right:6px;';
          badgeBar.appendChild(pill);
        });
      }
      
      // Title effects - decorative elements
      if (displayName && cos.titleEffect) {
        const existingTitle = displayName.querySelector('.title-effect-decoration');
        if (existingTitle) existingTitle.remove();
        
        const titleDecor = document.createElement('span');
        titleDecor.className = 'title-effect-decoration';
        titleDecor.style.marginLeft = '8px';
        titleDecor.style.display = 'inline-block';
        titleDecor.style.verticalAlign = 'middle';
        
        // Rare titles
        if (cos.titleEffect === 'crown') {
          titleDecor.textContent = 'üëë';
          titleDecor.style.fontSize = '18px';
        } else if (cos.titleEffect === 'halo') {
          titleDecor.textContent = '‚≠ê';
          titleDecor.style.fontSize = '16px';
        }
        // Legendary titles
        else if (cos.titleEffect === 'emperor-crown') {
          titleDecor.textContent = 'üëë‚ú®';
          titleDecor.style.fontSize = '20px';
          titleDecor.style.filter = 'drop-shadow(0 0 4px rgba(251,191,36,0.8))';
        }
        // Eternal titles
        else if (cos.titleEffect === 'god-mode') {
          titleDecor.textContent = '‚òÄÔ∏è';
          titleDecor.style.fontSize = '20px';
          titleDecor.style.filter = 'drop-shadow(0 0 6px rgba(167,139,250,0.9))';
          titleDecor.style.animation = 'cosmetic-shimmer 2s infinite';
        }
        // MYTHIC titles
        else if (cos.titleEffect === 'sacred-sigil') {
          titleDecor.textContent = 'üî±';
          titleDecor.style.fontSize = '22px';
          titleDecor.style.filter = 'drop-shadow(0 0 8px rgba(34,211,238,1))';
          titleDecor.style.animation = 'mythic-name-effect 2s infinite';
        } else if (cos.titleEffect === 'titan-helm') {
          titleDecor.textContent = '‚öîÔ∏è';
          titleDecor.style.fontSize = '22px';
          titleDecor.style.filter = 'drop-shadow(0 0 8px rgba(34,211,238,1))';
          titleDecor.style.animation = 'mythic-name-effect 2s infinite';
        } else if (cos.titleEffect === 'oracle-vision') {
          titleDecor.textContent = 'üëÅÔ∏è';
          titleDecor.style.fontSize = '22px';
          titleDecor.style.filter = 'drop-shadow(0 0 8px rgba(34,211,238,1))';
          titleDecor.style.animation = 'mythic-name-effect 2s infinite';
        }
        // TRANSCENDENT titles
        else if (cos.titleEffect === 'celestial-ring') {
          titleDecor.textContent = 'ü™ê';
          titleDecor.style.fontSize = '24px';
          titleDecor.style.filter = 'drop-shadow(0 0 12px rgba(124,58,237,1)) drop-shadow(0 0 24px rgba(124,58,237,0.8))';
          titleDecor.style.animation = 'transcendent-name-effect 2s infinite';
        } else if (cos.titleEffect === 'omniscient') {
          titleDecor.textContent = '‚ú®üëÅÔ∏è‚ú®';
          titleDecor.style.fontSize = '24px';
          titleDecor.style.filter = 'drop-shadow(0 0 12px rgba(124,58,237,1)) drop-shadow(0 0 24px rgba(124,58,237,0.8))';
          titleDecor.style.animation = 'transcendent-name-effect 2s infinite';
        } else if (cos.titleEffect === 'reality-weaver') {
          titleDecor.textContent = 'üåÄüí´';
          titleDecor.style.fontSize = '24px';
          titleDecor.style.filter = 'drop-shadow(0 0 12px rgba(124,58,237,1)) drop-shadow(0 0 24px rgba(124,58,237,0.8))';
          titleDecor.style.animation = 'transcendent-name-effect 2s infinite';
        }
        
        if (titleDecor.textContent) {
          displayName.appendChild(titleDecor);
        }
      }
      
      // Verified badge inline next to name
      const verifiedEl = document.getElementById('verifiedBadge');
      if (verifiedEl) {
        // Hide separate container; render inline on the name
        verifiedEl.style.display = 'none';
      }
      if (displayName) {
        const existingInline = displayName.querySelector('.inline-verified-badge');
        if (existingInline) existingInline.remove();
        if (settings?.verified) {
          const span = document.createElement('span');
          span.className = 'inline-verified-badge';
          span.style.display = 'inline-block';
          span.style.verticalAlign = 'middle';
          span.style.marginLeft = '6px';
          span.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" style="display:inline-block;vertical-align:middle;margin-bottom:2px;"><circle cx="12" cy="12" r="11" fill="#fff" stroke="#0f172a" stroke-width="1.5" /><path d="M8.5 12.5l2.2 2.2 4.8-5.4" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>';
          displayName.appendChild(span);
        }
      }
      // Chat color alias (unused for student page visuals but kept for consistency)
      const chatColor = cos.chatColor || cos.chatBubbleColor || '';
      if (chatColor) {
        document.documentElement.style.setProperty('--chat-accent', chatColor);
      }
      // Inject cosmetic animations if not already present
      injectCosmeticAnimations();
    }catch(e){ console.warn('applyCosmetics failed', e); }
  }

  // ---------- VIRTUAL PET SYSTEM ----------
  async function loadAndDisplayPet(settings) {
    try {
      console.log('[Pet Debug] loadAndDisplayPet called with settings:', settings);
      const equipped = settings?.cosmetics?.virtualPet || null;
      console.log('[Pet Debug] Equipped pet:', equipped);
      if (!equipped) {
        document.getElementById('petContainer').style.display = 'none';
        return;
      }

      // Show pet container
        console.log('[Pet Debug] Showing pet container');
      document.getElementById('petContainer').style.display = 'block';

      // Fetch greeting
      const res = await fetch(`${API}/api/pet/greeting`, { headers: authHeaders() });
      if (!res.ok) return;
      const { greeting, mood, hour } = await res.json();

      // Update pet display
      const petMap = {
        'dragon-pet': { emoji: 'üêâ', name: 'Dragon Companion' },
        'phoenix-pet': { emoji: 'üî•üê¶', name: 'Phoenix Ally' },
        'unicorn-pet': { emoji: 'ü¶Ñ', name: 'Unicorn Spirit' },
        'wolf-pet': { emoji: 'üê∫', name: 'Shadow Wolf' },
        'fairy-pet': { emoji: 'üßö', name: 'Magic Fairy' }
      };

      const pet = petMap[equipped] || { emoji: 'üêâ', name: 'Pet' };
      
      document.getElementById('petGreeting').textContent = greeting;
      document.getElementById('petAvatar').textContent = pet.emoji;
      document.getElementById('petName').textContent = pet.name;

      // Add animation based on mood
      const petAvatar = document.getElementById('petAvatar');
      petAvatar.style.animation = '';
      if (mood === 'energetic') {
        petAvatar.style.animation = 'cosmetic-spin 1.5s infinite';
      } else if (mood === 'sleepy') {
        petAvatar.style.animation = 'cosmetic-shimmer 2s infinite';
      } else if (mood === 'calm') {
        petAvatar.style.animation = 'cosmetic-pulse 2s infinite';
      }

      // Celebration checks (birthday / join anniversary) for special messages + confetti
      try {
        const dobStr = currentProfile?.dob; // ISO date or yyyy-mm-dd
        const joinedStr = currentProfile?.createdAt;
        const today = new Date();

        const isSameMonthDay = (dateStr) => {
          if (!dateStr) return false;
          const d = new Date(dateStr);
          return d.getMonth() === today.getMonth() && d.getDate() === today.getDate();
        };

        if (isSameMonthDay(dobStr)) {
          showCelebration("üéâ Happy Birthday! Your pet is celebrating with you!");
          showConfetti(3000);
        } else if (isSameMonthDay(joinedStr)) {
          showCelebration("üéä Happy Join Anniversary! Your companion is proud of you!");
          showConfetti(3000);
        }
      } catch (e) { /* ignore */ }
    } catch (e) {
      console.warn('Pet display failed:', e);
    }
  }

  // Celebration helpers
  function showCelebration(message){
    const el = document.getElementById('petGreeting');
    if (!el) return;
    el.textContent = message;
    el.style.filter = 'drop-shadow(0 0 6px rgba(255,255,255,0.7))';
  }

  // Lightweight confetti using emojis
  function showConfetti(durationMs=2500){
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.top = 0;
    overlay.style.left = 0;
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.pointerEvents = 'none';
    overlay.style.zIndex = 9999;
    document.body.appendChild(overlay);

    const emojis = ['üéâ','‚ú®','üéä','‚≠ê','üí´','üåü'];
    const count = 40;
    for (let i=0;i<count;i++){
      const span = document.createElement('span');
      span.textContent = emojis[Math.floor(Math.random()*emojis.length)];
      span.style.position = 'absolute';
      span.style.fontSize = (Math.random()*24 + 18) + 'px';
      span.style.left = Math.floor(Math.random()*100) + '%';
      span.style.top = '-10%';
      span.style.transform = `rotate(${Math.floor(Math.random()*360)}deg)`;
      span.style.animation = 'fallConfetti 2.6s ease-in forwards';
      overlay.appendChild(span);
    }

    setTimeout(()=>{ overlay.remove(); }, durationMs);
  }

  // Add confetti keyframes once
  (function addConfettiStyles(){
    if (document.getElementById('ascended-confetti-style')) return;
    const style = document.createElement('style');
    style.id = 'ascended-confetti-style';
    style.textContent = `@keyframes fallConfetti { from { transform: translateY(-10vh); opacity: 1; } to { transform: translateY(100vh); opacity: 0.2; } }`;
    document.head.appendChild(style);
  })();

  // ---------- COSMETIC ANIMATIONS INJECTOR ----------
  function injectCosmeticAnimations() {
    if (document.getElementById('cosmetic-animations')) return;
    const style = document.createElement('style');
    style.id = 'cosmetic-animations';
    style.textContent = `
      @keyframes cosmetic-pulse {
        0%, 100% { box-shadow: 0 0 8px rgba(59,130,246,0.6); }
        50% { box-shadow: 0 0 20px rgba(59,130,246,1); }
      }
      @keyframes cosmetic-spin {
        from { transform: rotate(0deg); filter: hue-rotate(0deg); }
        to { transform: rotate(360deg); filter: hue-rotate(360deg); }
      }
      @keyframes mythic-avatar-glow {
        0%, 100% { box-shadow: 0 0 20px rgba(34,211,238,1), 0 0 40px rgba(34,211,238,0.8), 0 0 60px rgba(34,211,238,0.6); transform: scale(1); }
        50% { box-shadow: 0 0 30px rgba(34,211,238,1), 0 0 60px rgba(34,211,238,1), 0 0 90px rgba(34,211,238,0.8); transform: scale(1.05); }
      }
      @keyframes transcendent-avatar-glow {
        0%, 100% { box-shadow: 0 0 30px rgba(124,58,237,1), 0 0 60px rgba(124,58,237,1), 0 0 90px rgba(124,58,237,0.8), 0 0 120px rgba(124,58,237,0.6); transform: scale(1) rotate(0deg); }
        50% { box-shadow: 0 0 50px rgba(124,58,237,1), 0 0 100px rgba(124,58,237,1), 0 0 150px rgba(124,58,237,0.9), 0 0 200px rgba(124,58,237,0.7); transform: scale(1.08) rotate(5deg); }
      }
      @keyframes mythic-name-effect {
        0%, 100% { text-shadow: 0 0 10px rgba(34,211,238,1), 0 0 20px rgba(34,211,238,0.8), 0 0 30px rgba(34,211,238,0.6); filter: brightness(1); }
        50% { text-shadow: 0 0 20px rgba(34,211,238,1), 0 0 40px rgba(34,211,238,1), 0 0 60px rgba(34,211,238,0.9); filter: brightness(1.2); }
      }
      @keyframes transcendent-name-effect {
        0% { text-shadow: 0 0 15px rgba(124,58,237,1), 0 0 30px rgba(124,58,237,1), 0 0 45px rgba(124,58,237,0.8); transform: translateY(0px); }
        25% { text-shadow: 0 0 25px rgba(124,58,237,1), 0 0 50px rgba(124,58,237,1), 0 0 75px rgba(124,58,237,1); transform: translateY(-2px); }
        50% { text-shadow: 0 0 35px rgba(124,58,237,1), 0 0 70px rgba(124,58,237,1), 0 0 105px rgba(255,255,255,0.8); transform: translateY(-3px) scale(1.03); }
        75% { text-shadow: 0 0 25px rgba(124,58,237,1), 0 0 50px rgba(124,58,237,1), 0 0 75px rgba(124,58,237,1); transform: translateY(-2px); }
        100% { text-shadow: 0 0 15px rgba(124,58,237,1), 0 0 30px rgba(124,58,237,1), 0 0 45px rgba(124,58,237,0.8); transform: translateY(0px); }
      }
      @keyframes cosmetic-rainbow {
        from { filter: hue-rotate(0deg); }
        to { transform: rotate(360deg); filter: hue-rotate(360deg); }
      }
      @keyframes cosmetic-rainbow {
        0% { filter: hue-rotate(0deg); }
        100% { filter: hue-rotate(360deg); }
      }
      @keyframes cosmetic-shimmer {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
      }
    `;
    document.head.appendChild(style);
  }

  // Global feature flags
  let systemFeatures = {...(typeof DEFAULT_FEATURES !== 'undefined' ? DEFAULT_FEATURES : {
    shop: true,
    cosmetics: true,
    redeemCodes: true,
    appeals: true,
    dailyRewards: true,
    chat: true,
    petDisplay: true,
    achievements: true
  })};

  // ---------- API CALLS ----------
  async function fetchProfile() {
    try {
      // Ensure CSRF is ready before hitting protected endpoints
      if (!isCSRFLoaded) {
        await loadCSRF();
      }

      const res = await fetch(`${API}/api/me`, { headers: authHeaders(), credentials:'include' });

      if (res.status === 401 || res.status === 403) { handleLogoutRedirect(); return null; }
      if (!res.ok) { safeSet(displayName, 'Unnamed'); safeSet(displayEmail, '‚Äî'); safeSet(displayRoll, 'Roll: ‚Äî'); safeSet(displayDept, 'Dept: ‚Äî'); showLocalAvatar(); return null; }

      const data = await res.json();
      currentProfile = data;
      
      // Update feature flags from server
      if (data.features) {
        systemFeatures = { ...systemFeatures, ...data.features };
        applyFeatureToggles();
      }
      safeSet(displayName, data.name || data.roll || 'Unnamed');
      safeSet(displayEmail, data.email || '‚Äî');
      safeSet(displayRoll, 'Roll: ' + (data.roll || (userRoll || '‚Äî')));
      safeSet(displayDept, 'Dept: ' + (data.dept || '‚Äî'));
      lastLoginEl.textContent = new Date(data.updatedAt || data.createdAt || Date.now()).toLocaleString();
      profilePct.textContent = calculateProfilePct(data) + '%';

      if (data.avatarUrl) {
        avatarImg.src = data.avatarUrl;
        try { localStorage.setItem('avatarData', data.avatarUrl); } catch(e){}
      } else showLocalAvatar();

      // Account Lock Status
      if (data.lockedUntil) {
        const until = new Date(data.lockedUntil);
        if (until > new Date()) {
          accountLockState.textContent = 'üîí Locked';
          accountLockState.style.color = 'var(--danger)';
          accountLockReason.textContent = `Until ${until.toLocaleString()}`;
          accountLockMeta.innerHTML = `<div class="mutedSmall">Account locked by admin. Cannot access system features.</div>`;
        } else {
          accountLockState.textContent = '‚úÖ Active';
          accountLockState.style.color = 'var(--success)';
          accountLockReason.textContent = '';
          accountLockMeta.innerHTML = '';
        }
      } else {
        accountLockState.textContent = '‚úÖ Active';
        accountLockState.style.color = 'var(--success)';
        accountLockReason.textContent = '';
        accountLockMeta.innerHTML = '';
      }

      // Chatbot Lock Status (separate from account lock)
      if (data.chatbotLockedUntil) {
        const until = new Date(data.chatbotLockedUntil);
        if (until > new Date()) {
          chatbotLockState.textContent = 'üö´ Locked';
          chatbotLockState.style.color = 'var(--danger)';
          chatbotLockReason.textContent = `Until ${until.toLocaleString()}`;
          chatbotLockMeta.innerHTML = `<div class="mutedSmall">Reason: ${data.chatbotLockReason || 'Policy violation'}. Cannot use chatbot.</div>`;
        } else {
          chatbotLockState.textContent = '‚úÖ Accessible';
          chatbotLockState.style.color = 'var(--success)';
          chatbotLockReason.textContent = '';
          chatbotLockMeta.innerHTML = '';
        }
      } else {
        chatbotLockState.textContent = '‚úÖ Accessible';
        chatbotLockState.style.color = 'var(--success)';
        chatbotLockReason.textContent = '';
        chatbotLockMeta.innerHTML = '';
      }

      applyCosmetics(data.settings);
      loadAndDisplayPet(data.settings);
      renderWarningsFromProfile(data);
      renderAchievements(data);
      renderShop();
      renderCosmetics();
      loadDailyRewardsStatus();
      return data;
    } catch (err) {
      console.error('fetchProfile error', err);
      safeSet(displayName, 'Unnamed'); safeSet(displayEmail, '‚Äî'); safeSet(displayRoll, 'Roll: ‚Äî'); safeSet(displayDept, 'Dept: ‚Äî'); showLocalAvatar();
      return null;
    }
  }

  // Apply feature toggles to UI elements
  function applyFeatureToggles() {
    // Find all feature-dependent buttons and elements
    const shopBtn = Array.from(document.querySelectorAll('button')).find(b => b.textContent.includes('HC Shop'));
    const redeemBtn = Array.from(document.querySelectorAll('button')).find(b => b.textContent.includes('Redeem Code'));
    const cosmeticsBtn = Array.from(document.querySelectorAll('button')).find(b => b.textContent.includes('Cosmetics'));
    const loginRewardsCard = document.getElementById('loginRewardsCard');
    const studentAppealCard = document.getElementById('studentAppealCard');
    const petContainer = document.getElementById('petContainer');
    const achievementsCard = document.getElementById('achievementsCard');
    
    // Shop
    if (shopBtn) shopBtn.style.display = systemFeatures.shop ? '' : 'none';
    
    // Redeem Codes
    if (redeemBtn) redeemBtn.style.display = systemFeatures.redeemCodes ? '' : 'none';
    
    // Cosmetics
    if (cosmeticsBtn) cosmeticsBtn.style.display = systemFeatures.cosmetics ? '' : 'none';
    
    // Daily Rewards
    if (loginRewardsCard) loginRewardsCard.style.display = systemFeatures.dailyRewards ? '' : 'none';
    
    // Appeals
    if (studentAppealCard) studentAppealCard.style.display = systemFeatures.appeals ? '' : 'none';
    
    // Pet Display
    if (petContainer && currentProfile?.settings?.cosmetics?.virtualPet) {
      petContainer.style.display = systemFeatures.petDisplay ? '' : 'none';
    }
    
    // Achievements
    if (achievementsCard) achievementsCard.style.display = systemFeatures.achievements ? '' : 'none';
  }

  async function fetchChatHistoryAndUsage() {
    try {
      if (!userRoll) { totalChatsEl.textContent = '‚Äî'; weeklyChatsEl.textContent = '‚Äî'; lastChatEl.textContent = '‚Äî'; return; }
      const res = await fetch(`${API}/api/chat/${encodeURIComponent(userRoll)}`, { headers: authHeaders() });
      if (!res.ok) { totalChatsEl.textContent = '‚Äî'; weeklyChatsEl.textContent = '‚Äî'; lastChatEl.textContent = '‚Äî'; return; }

      const history = await res.json();
      const total = Array.isArray(history) ? history.length : 0;
      const oneWeekAgo = Date.now() - 7*24*3600*1000;
      const weekly = Array.isArray(history) ? history.filter(h => (new Date(h.createdAt || h.time || Date.now()).getTime() > oneWeekAgo)).length : 0;
      const last = (Array.isArray(history) && history[0]) ? new Date(history[0].createdAt || history[0].time || Date.now()).toLocaleString() : '‚Äî';
      totalChatsEl.textContent = total;
      weeklyChatsEl.textContent = weekly;
      lastChatEl.textContent = last;
    } catch (err) { console.error('fetchChatHistory error', err); totalChatsEl.textContent = '‚Äî'; weeklyChatsEl.textContent = '‚Äî'; lastChatEl.textContent = '‚Äî'; }
  }

  async function fetchNotices() {
    try {
      const res = await fetch(`${API}/api/notices`, { headers: authHeaders() });
      if (!res.ok) { noticesList.textContent = 'No notices at the moment.'; return; }
      const data = await res.json();
      if (!Array.isArray(data) || data.length === 0) { noticesList.textContent = 'No notices at the moment.'; return; }
      noticesList.innerHTML = '';
      data.slice(0,5).forEach(n => {
        const el = document.createElement('div'); el.className = 'notice';
        el.textContent = n.title ? `${n.title} ‚Äî ${n.body || ''}` : (n.body || '');
        noticesList.appendChild(el);
      });
    } catch (err) { noticesList.textContent = 'No notices at the moment.'; }
  }

  // ---------- Mailbox ----------
  function renderMailbox(items){
    mailList.innerHTML = '';
    if(items.length===0){ mailList.textContent = 'No messages.'; return; }
    items.slice(0,10).forEach(m=>{
      const wrap = document.createElement('div');
      wrap.className = 'mail-item';
      const title = m.title || (m.type === 'reward' ? 'Reward' : 'Message');
      const body = m.body || m.message || '';
      const created = new Date(m.createdAt || Date.now()).toLocaleString();
      const unread = m.read ? '' : '<span class="badge">unread</span>';
      const typeBadge = `<span class="badge">${(m.type||'system')}</span>`;
      wrap.innerHTML = `<strong>${title}</strong> ${typeBadge} ${unread}<div style="margin-top:6px">${body}</div><div class="mail-meta">${created}</div>`;
      const actions = document.createElement('div'); actions.className = 'mail-actions';
      const markBtn = document.createElement('button'); markBtn.className = 'btn small'; markBtn.textContent = 'Mark as read';
      markBtn.onclick = async ()=>{ try{ await fetch(`${API}/api/student/system-messages/${encodeURIComponent(m._id)}/read`, { method:'POST', headers: authHeaders() }); fetchMailbox(); }catch(e){} };
      actions.appendChild(markBtn);
      wrap.appendChild(actions);
      mailList.appendChild(wrap);
    });
  }

  async function fetchMailbox(){
    try{
      const res = await fetch(`${API}/api/mailbox`, { headers: authHeaders() });
      if (!res.ok) { mailList.textContent = 'No messages.'; return; }
      const data = await res.json();
      renderMailbox(Array.isArray(data) ? data : []);
    } catch (err) { mailList.textContent = 'No messages.'; }
  }

  async function fetchWarnings() {
    try {
      if (!userRoll) return;
      const res = await fetch(`${API}/api/admin/warnings/${encodeURIComponent(userRoll)}`, { headers: authHeaders() });
      if (!res.ok) return;
      const data = await res.json();
      renderWarningsList(data);
    } catch (err) {}
  }

  function renderWarningsList(list) {
    warningsContainer.innerHTML = '';
    if (!Array.isArray(list) || list.length === 0) { warningsContainer.innerHTML = '<div class="muted">You have no warnings.</div>'; return; }
    list.forEach(w => {
      const d = document.createElement('div');
      d.style.padding = '8px';
      d.style.borderBottom = '1px dashed rgba(255,255,255,0.06)';
      d.innerHTML = `<strong style="color:${w.level==='high'?'#ffb4b4':'#ffd480'}">${(w.level||'low').toUpperCase()}</strong> ‚Äî ${w.reason} <div style="font-size:12px;color:rgba(255,255,255,0.75)">${new Date(w.createdAt).toLocaleString()}</div>`;
      warningsContainer.appendChild(d);
    });
  }

  function renderWarningsFromProfile(profile) {
    warningsContainer.innerHTML = '';
    const c = profile?.warningsCount || 0;
    if (c === 0) { warningsContainer.innerHTML = '<div class="muted">You have no warnings.</div>'; return; }
    const d = document.createElement('div');
    d.style.padding = '8px';
    d.innerHTML = `<strong style="color:var(--danger)">You have ${c} warning(s)</strong><div style="font-size:12px;color:rgba(255,255,255,0.8)">Contact admin for details.</div>`;
    warningsContainer.appendChild(d);
  }

  // ---------- Achievements ----------
  function computeAchievements(profile){
    const ach = [];
    const unlocked = profile?.settings?.unlocked || {};
    const titles = unlocked.titleEffects || [];
    const pets = unlocked.virtualPets || [];

    const ASCENDED_PETS = ['godling-pet','leviathan-pet','sentinel-pet','chimera-pet','reaper-pet'];
    const SUPREME_PETS = ['dragon-pet','phoenix-pet','unicorn-pet','wolf-pet','fairy-pet'];

    if (pets.some(p=>ASCENDED_PETS.includes(p))) {
      ach.push({icon:'üí†', name:'Ascended Companion', desc:'Own an ASCENDED tier pet'});
    }
    if (pets.some(p=>SUPREME_PETS.includes(p))) {
      ach.push({icon:'üî•', name:'Supreme Tamer', desc:'Own a SUPREME tier pet'});
    }
    if (titles.includes('absolute-sovereign')) {
      ach.push({icon:'üëë', name:'Absolute Sovereign', desc:'Unlocked exclusive sovereign title'});
    }

    // Starter milestone: any cosmetic unlocked
    const anyUnlocked = Object.values(unlocked).some(v=>Array.isArray(v) && v.length>0);
    if (anyUnlocked) {
      ach.push({icon:'‚ú®', name:'First Unlock', desc:'Unlocked your first cosmetic'});
    }

    return ach;
  }

  // ---------- Daily Login Rewards ----------
  async function loadDailyRewardsStatus(){
    try {
      const res = await fetch(`${API}/api/daily-rewards/status`, { headers: authHeaders() });
      if (!res.ok) return;
      const { currentDay, claimedToday } = await res.json();
      
      currentDayEl.textContent = currentDay;
      renderDailyRewardsList(currentDay, claimedToday);

      if (claimedToday) {
        claimRewardBtn.disabled = true;
        claimRewardBtn.textContent = '‚úÖ Claimed Today';
        claimRewardBtn.style.background = '#6b7280';
      }
    } catch (e) { console.warn('Daily rewards status failed:', e); }
  }

  // ---------- Student Appeal Modal ----------
  function openStudentAppealModal(){
    if (!systemFeatures.appeals) {
      alert('üö´ Appeals feature is currently disabled by administrators.');
      return;
    }
    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.innerHTML = `
      <div class="modal">
        <div class="modal-header">
          <h3>Submit Appeal / Message</h3>
          <button class="btn ghost" onclick="this.closest('.modal-overlay').remove()">‚úñ</button>
        </div>
        <div class="modal-content">
          <label class="mutedSmall">Type</label>
          <select id="appealType" class="input" style="width:100%;margin-bottom:8px;">
            <option value="appeal">General Appeal</option>
            <option value="violation-question">Violation Question</option>
            <option value="lock-appeal">Account/Chatbot Lock Appeal</option>
          </select>
          <label class="mutedSmall">Subject</label>
          <input id="appealSubject" class="input" placeholder="Subject" style="width:100%;margin-bottom:8px;" />
          <label class="mutedSmall">Message</label>
          <textarea id="appealMessage" class="input" placeholder="Write your message..." style="width:100%;height:120px;"></textarea>
          <button class="btn primary" style="margin-top:12px;width:100%;" onclick="submitStudentAppeal(this)">Send</button>
        </div>
      </div>`;
    document.body.appendChild(modal);
  }

  // ---------- Redeem Code Modal ----------
  function openRedeemCodeModal(){
    if (!systemFeatures.redeemCodes) {
      alert('üö´ Redeem codes feature is currently disabled by administrators.');
      return;
    }
    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.innerHTML = `
      <div class="modal">
        <div class="modal-header">
          <h3>üéüÔ∏è Redeem Code</h3>
          <button class="btn ghost" onclick="this.closest('.modal-overlay').remove()">‚úñ</button>
        </div>
        <div class="modal-content">
          <p style="opacity:0.8;">Enter a redeem code to claim rewards.</p>
          <input id="redeemCodeInput" placeholder="Enter code (e.g., ABC123)" />
          <div style="display:flex;justify-content:flex-end;margin-top:10px;">
            <button onclick="submitRedeemCode()" style="background:#34d399;color:#000;font-weight:600;">Redeem</button>
          </div>
        </div>
      </div>`;
    document.body.appendChild(modal);
  }

  async function submitRedeemCode(){
    try {
      const overlay = document.querySelector('.modal-overlay.active');
      const input = document.getElementById('redeemCodeInput');
      const code = (input?.value || '').trim();
      if (!code) { alert('Please enter a code'); return; }
      if (!isCSRFLoaded) await loadCSRF();
      const res = await fetch(`${API}/api/student/redeem-code`, { method:'POST', headers: authHeaders(), credentials:'include', body: JSON.stringify({ code }) });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) { alert('‚ùå ' + (data.error || 'Redeem failed')); return; }
      
      // Apply reward locally
      if (data.reward?.type === 'hc') {
        currentProfile.hc = (currentProfile.hc || 0) + (data.reward.amount || 0);
      } else if (data.reward?.type === 'cosmetic') {
        const parts = (data.reward.value || '').split(':');
        const category = parts[0] || 'titleEffects';
        const value = parts[1] || parts[0];
        currentProfile.settings = currentProfile.settings || {}; 
        currentProfile.settings.unlocked = currentProfile.settings.unlocked || {};
        const list = currentProfile.settings.unlocked[category] || [];
        if (!list.includes(value)) {
          currentProfile.settings.unlocked[category] = [...list, value];
        }
      } else if (data.reward?.type === 'badge') {
        currentProfile.settings = currentProfile.settings || {}; 
        currentProfile.settings.unlocked = currentProfile.settings.unlocked || {};
        const list = currentProfile.settings.unlocked.badges || [];
        if (!list.includes(data.reward.value)) {
          currentProfile.settings.unlocked.badges = [...list, data.reward.value];
        }
      }
      
      // Refresh UI
      renderShop();
      renderCosmetics();
      renderAchievements(currentProfile);
      applyCosmetics(currentProfile.settings);
      loadAndDisplayPet(currentProfile.settings);
      alert('‚úÖ ' + (data.message || 'Code redeemed'));
      overlay?.remove();
    } catch (e) {
      console.error('Redeem error:', e);
      alert('‚ùå Network error');
    }
  }

  async function submitStudentAppeal(btn){
    try{
      btn.disabled = true; btn.textContent = 'Sending...';
      if (!isCSRFLoaded) await loadCSRF();
      const type = document.getElementById('appealType').value;
      const subject = document.getElementById('appealSubject').value.trim();
      const message = document.getElementById('appealMessage').value.trim();
      if (!subject || !message) { alert('Please fill subject and message'); btn.disabled=false; btn.textContent='Send'; return; }
      const res = await fetch(`${API}/api/student/messages/submit`, {
        method:'POST', headers: authHeaders(), credentials:'include',
        body: JSON.stringify({ type, subject, message })
      });
      const data = await res.json();
      if (!res.ok) { alert('‚ùå ' + (data.error||'Failed')); btn.disabled=false; btn.textContent='Send'; return; }
      alert('‚úÖ Message submitted');
      document.querySelector('.modal-overlay')?.remove();
      loadStudentMessages();
    }catch(e){ alert('‚ùå Failed to submit'); console.error(e); btn.disabled=false; btn.textContent='Send'; }
  }

  async function loadStudentMessages(){
    try{
      const res = await fetch(`${API}/api/student/messages`, { headers: authHeaders() });
      if(!res.ok){ studentMessagesList.textContent = 'No messages.'; return; }
      const all = await res.json();
      const list = Array.isArray(all) ? all.filter(m => (m.status || 'pending') !== 'closed') : [];
      if(list.length===0){ studentMessagesList.textContent = 'No messages.'; return; }
      studentMessagesList.innerHTML = list.slice(0,5).map(m=>{
        const status = m.status || 'pending';
        const unread = status !== 'read' ? '<span class="badge" style="margin-left:6px;background:rgba(234,179,8,0.25);">unread</span>' : '';
        const reply = m.adminReply ? `<div class="mutedSmall" style="margin-top:6px;">Admin: ${m.adminReply}</div>` : '';
        const labels = Array.isArray(m.labels) && m.labels.length ? `<div style="margin-top:6px;">${m.labels.map(l=>`<span class='badge' style='background:rgba(59,130,246,0.3);margin-right:6px;'>${l}</span>`).join('')}</div>` : '';
        return `<div style="padding:8px;border-bottom:1px dashed rgba(255,255,255,0.07)"><strong>[${m.type}] ${m.subject}</strong>${unread}<div class="mutedSmall">${new Date(m.createdAt).toLocaleString()} ‚Äî ${status}</div><div style="margin-top:6px;">${m.message}</div>${labels}${reply}</div>`;
      }).join('');
    }catch(e){ studentMessagesList.textContent = 'No messages.'; }
  }

  function renderDailyRewardsList(currentDay, claimed){
    loginRewardsList.innerHTML = '';
    for (let i=1; i<=7; i++){
      const box = document.createElement('div');
      const isToday = i === currentDay;
      const isCompleted = i < currentDay || (i === currentDay && claimed);
      
      box.style.cssText = `
        padding: 10px 4px;
        border-radius: 8px;
        text-align: center;
        font-weight: 700;
        font-size: 12px;
        cursor: default;
        transition: 0.3s;
        ${isToday ? 'background: linear-gradient(135deg, #22d3ee, #06b6d4); color: #000; border: 2px solid #00ffff; box-shadow: 0 0 10px rgba(0,255,255,0.5);' : ''}
        ${isCompleted && !isToday ? 'background: #34d399; color: #000;' : ''}
        ${!isToday && !isCompleted ? 'background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.5);' : ''}
      `;
      box.textContent = isCompleted ? '‚úÖ' : `Day ${i}`;
      loginRewardsList.appendChild(box);
    }
  }

  async function claimDailyReward(){
    if (!systemFeatures.dailyRewards) {
      alert('üö´ Daily rewards feature is currently disabled by administrators.');
      return;
    }
    try {
      const res = await fetch(`${API}/api/daily-rewards/claim`, {
        method: 'POST',
        headers: authHeaders(),
        credentials: 'include',
        body: JSON.stringify({})
      });
      if (!res.ok) {
        const err = await res.json();
        alert('‚ùå ' + (err.error || 'Failed to claim'));
        return;
      }
      const { message, reward } = await res.json();
      currentProfile.hc = (currentProfile.hc || 0) + reward.hc;
      alert(`üéâ ${message}`);
      loadDailyRewardsStatus();
      renderShop();
    } catch (e) {
      alert('‚ùå Claim failed');
      console.error(e);
    }
  }

  function renderAchievements(profile){
    if (!achievementsList) return;
    const list = computeAchievements(profile);
    if (!list.length) { achievementsList.textContent = 'No achievements yet. Visit the Shop and Cosmetics to unlock some!'; return; }
    const html = list.map(a=>`
      <div style="display:flex;align-items:center;gap:10px;padding:8px;border-bottom:1px dashed rgba(255,255,255,0.07)">
        <div style="font-size:22px">${a.icon}</div>
        <div>
          <div style="font-weight:700">${a.name}</div>
          <div class="mutedSmall">${a.desc}</div>
        </div>
      </div>
    `).join('');
    achievementsList.innerHTML = html;
  }

  function calculateProfilePct(data) {
    const fields = ['name','email','roll','dept','cls','avatarUrl'];
    let filled = 0;
    fields.forEach(f=> { if (data && data[f]) filled++; });
    return Math.round((filled / fields.length) * 100);
  }

  // ---------- Avatar upload ----------
  avatarFile.addEventListener('change', async (e) => {
    const f = e.target.files[0]; if (!f) return;
    const reader = new FileReader();
    reader.onload = async () => {
      const dataUrl = reader.result;
      avatarImg.src = dataUrl;
      try { localStorage.setItem('avatarData', dataUrl); } catch(e){}
      try {
        await fetch(`${API}/api/student`, { method:'POST', headers: authHeaders(), body: JSON.stringify({ roll:userRoll, name: displayName.textContent, dept:(displayDept.textContent || '').replace('Dept: ','') || '', cls:'', avatarUrl:dataUrl }) });
      } catch(err){}
    };
    reader.readAsDataURL(f);
  });

  // ---------- Buttons ----------
  openChatBtn.addEventListener('click', ()=> location.href = 'chatbot.html');
  openChatBtn2.addEventListener('click', ()=> location.href = 'chatbot.html');
  settingsBtn.addEventListener('click', ()=> location.href = 'settings.html');

  async function handleLogoutRedirect() {
    try {
      await fetch(`${API}/api/auth/logout`, { method:'POST', headers: authHeaders(), body: JSON.stringify({ refreshToken: getRefreshToken() }) });
    } catch(err){}
    try {
      ['token','accessToken','authToken'].forEach(k=>{ localStorage.removeItem(k); sessionStorage.removeItem(k); });
      localStorage.removeItem('avatarData');
    } catch(e){}
    location.href = 'index.html';
  }

  logoutBtn.addEventListener('click', ()=> { if(confirm('Logout now?')) handleLogoutRedirect(); });
  editProfileBtn.addEventListener('click', ()=> location.href = 'profile.html');

  // ---------- Real-time socket.io ----------
  let socket = null;
  try {
    if (typeof io !== 'undefined') {
      socket = io({ auth: { token } });
      socket.on('connect', ()=> console.log('socket connected'));
      socket.on('warning:updated', (d)=> { if(d.roll===userRoll){ fetchProfile(); fetchWarnings(); } });
      socket.on('student:locked', (d)=> { if(d.roll===userRoll) fetchProfile(); });
      socket.on('student:unlocked', (d)=> { if(d.roll===userRoll) fetchProfile(); });
      socket.on('cosmetic:updated', (d)=> { 
        if(d.roll===userRoll) {
          console.log('Cosmetic updated:', d);
          fetchProfile();
          if(currentProfile) {
            currentProfile.settings = currentProfile.settings || {};
            currentProfile.settings.unlocked = d.unlocked || currentProfile.settings.unlocked;
            currentProfile.settings.cosmetics = d.cosmetics || currentProfile.settings.cosmetics;
          }
        }
      });
      socket.on('verified:updated', (d)=> { if(d.roll===userRoll) fetchProfile(); });
      socket.on('coursePlan:updated', ()=> fetchNotices());
      socket.on('notice:new', ()=> fetchNotices());
      socket.on('chat:new', (chat)=> { if(chat.roll===userRoll) fetchChatHistoryAndUsage(); });
      
      // HC Currency updates
      socket.on('hc:updated', (d)=> { 
        if(d.roll===userRoll) {
          console.log('HC updated:', d);
          if(currentProfile) currentProfile.hc = d.hc;
          renderCosmetics();
          renderShop();
          alert(`‚ö° You received ${d.amount} Energy! New balance: ${d.hc}`);
        }
      });
      socket.on('hc:broadcast', (d)=> {
        console.log('HC broadcast received:', d);
        if(currentProfile) currentProfile.hc = (currentProfile.hc || 0) + d.amount;
        renderCosmetics();
        renderShop();
        alert(`üéÅ Admin sent everyone ${d.amount} Energy! Your new balance: ${currentProfile.hc}`);
      });
      // Real-time student message updates
      socket.on('student:message-replied', (d)=>{
        if(d.roll===userRoll){
          loadStudentMessages();
          alert('üì• Admin replied to your appeal/message');
        }
      });
      socket.on('student:message-closed', (d)=>{
        if(d.roll===userRoll){
          loadStudentMessages();
          fetchMailbox();
          alert(`üîí Appeal closed${d.reason ? `: ${d.reason}` : ''}`);
        }
      });
      socket.on('cosmetic:removed-violation', (d)=> {
        if(d.roll===userRoll) {
          console.log('Cosmetics removed due to violation:', d.removed);
          alert('‚ö†Ô∏è Premium cosmetics removed due to: ' + d.reason);
          fetchProfile();
        }
      });
      socket.on('notice:deleted', ()=> fetchNotices());
    }
  } catch(err){ console.warn('socket.io not available', err); }

  // ========== MODERN FEATURES ==========
  
  // Dark Mode Toggle
  function initDarkMode() {
    const isDark = localStorage.getItem('darkMode') === 'true';
    if (isDark) document.documentElement.classList.add('dark-mode');
  }
  
  document.getElementById('darkModeToggle').addEventListener('click', () => {
    const isDark = document.documentElement.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', isDark);
  });

  // Refresh Data
  document.getElementById('refreshDataBtn').addEventListener('click', async () => {
    const btn = document.getElementById('refreshDataBtn');
    btn.style.animation = 'spin 0.6s linear';
    await loadAll();
    setTimeout(() => btn.style.animation = '', 600);
  });

  // Export Chat History as JSON
  document.getElementById('exportBtn').addEventListener('click', async () => {
    try {
      const res = await fetch(`${API}/api/chat/${encodeURIComponent(userRoll)}`, { headers: authHeaders() });
      if (!res.ok) { alert('Failed to export'); return; }
      const history = await res.json();
      const dataStr = JSON.stringify(history, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `chat-history-${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);
    } catch(err) { alert('Export failed'); console.error(err); }
  });

  // Add spin animation
  const style = document.createElement('style');
  style.textContent = `@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }`;
  document.head.appendChild(style);

  // ---------- Initial load & polling ----------
  initDarkMode();
  async function loadAll() { await fetchProfile(); await fetchChatHistoryAndUsage(); await fetchNotices(); await fetchWarnings(); await fetchMailbox(); await loadStudentMessages(); renderStudentQR(); }
  let poll;
  (async () => {
    await loadCSRF();
    await loadAll();
    poll = setInterval(loadAll, 12000);
  })();

  // Render student's QR (no external lib; use Image API served by admin if exists, else lightweight SVG)
  function renderStudentQR(){
    try{
      const roll = userRoll;
      const name = (document.getElementById('displayName')?.textContent||'').trim();
      const dept = (document.getElementById('displayDept')?.textContent||'').replace('Dept: ','');
      const payload = JSON.stringify({ roll, name, dept, ts: Date.now() });

      // Generate simple QR-like block using third-party CDN as fallback (if policy allows) else render data as text block
      const el = document.getElementById('studentQRContainer');
      if(!el) return;
      const url = `https://api.qrserver.com/v1/create-qr-code/?size=140x140&data=${encodeURIComponent(payload)}`;
      el.innerHTML = `<img alt="qr" src="${url}" width="140" height="140" style="display:block"/>`;
    }catch(e){ /* ignore */ }
  }

  window.addEventListener('beforeunload', ()=> { clearInterval(poll); if(socket) socket.disconnect(); });
  showLocalAvatar();

  // ==================== COSMETICS MODAL ====================
  const cosmeticsModal = document.createElement('div');
  cosmeticsModal.className = 'modal-overlay';
  cosmeticsModal.id = 'cosmeticsModal';
  cosmeticsModal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚ú® Cosmetics Inventory</h2>
        <span class="modal-close" onclick="closeCosmeticsModal()">√ó</span>
      </div>
      <div id="cosmeticsContainer"></div>
    </div>
  `;
  document.body.appendChild(cosmeticsModal);

  // HC Shop Modal
  const shopModal = document.createElement('div');
  shopModal.className = 'modal-overlay';
  shopModal.id = 'shopModal';
  shopModal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h2>üõçÔ∏è HC Shop</h2>
        <span class="modal-close" onclick="closeShopModal()">√ó</span>
      </div>
      <div style="background:linear-gradient(135deg, rgba(34,211,238,0.2), rgba(6,182,212,0.15)); border:2px solid #22d3ee; border-radius:12px; padding:16px; margin-bottom:20px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h3 style="margin:0; color:#22d3ee;">‚ö° Your Energy</h3>
          <div id="shopBalance" style="background:rgba(34,211,238,0.3); padding:12px 16px; border-radius:8px; font-weight:700; color:#22d3ee; font-size:18px;">0 ‚ö°</div>
        </div>
      </div>
      <div id="shopContainer"></div>
    </div>
  `;
  document.body.appendChild(shopModal);

  // Cosmetics catalog with progressive tier system (higher tiers include all lower items + exclusives)
  const COSMETICS_CATALOG = {
    avatarBorders: [
      { value:'glow-blue', label:'Glow Blue', tier:'rare', preview:'üîµ Blue Glow' },
      { value:'gold', label:'Gold Border', tier:'rare', preview:'üü° Gold' },
      { value:'neon-pink', label:'Neon Pink', tier:'rare', preview:'üå∏ Pink' },
      { value:'dragon-fire', label:'Dragon Fire', tier:'legendary', preview:'üî• Animated Fire' },
      { value:'celestial-aura', label:'Celestial Aura', tier:'eternal', preview:'‚≠ê Galaxy Aura' },
      { value:'starlight-veil', label:'Starlight Veil (MYTHIC)', tier:'mythic', preview:'‚ú® Mythic Starlight Aura' },
      { value:'azure-phoenix', label:'Azure Phoenix (MYTHIC)', tier:'mythic', preview:'üê¶‚Äçüî• Cyan Phoenix' },
      { value:'crystal-fortress', label:'Crystal Fortress (MYTHIC)', tier:'mythic', preview:'üíé Crystal Shield' },
      { value:'prismatic-shield', label:'Prismatic Shield (TRANSCENDENT)', tier:'transcendent', preview:'üåà Ultimate Prism Shield' },
      { value:'eternal-flames', label:'Eternal Flames (TRANSCENDENT)', tier:'transcendent', preview:'üî•üí´ Infinite Fire' },
      { value:'void-emperor', label:'Void Emperor (TRANSCENDENT)', tier:'transcendent', preview:'üëëüåå Void Royalty' },
      { value:'singularity-crown', label:'Singularity Crown (SUPREME)', tier:'supreme', preview:'üåÄüëë Gravity Ring' },
      { value:'hypernova-crest', label:'Hypernova Crest (SUPREME)', tier:'supreme', preview:'üå† Radiant Nova' },
      { value:'primordial-halo', label:'Primordial Halo (ASCENDED)', tier:'ascended', preview:'‚ú®üëë Infinite Dimensional Aura' },
      { value:'genesis-crown', label:'Genesis Crown (ASCENDED)', tier:'ascended', preview:'üååüîç Origin of Realms' }
    ],
    nameStyles: [
      { value:'gradient-gold', label:'Gradient Gold', tier:'rare', preview:'Golden Text' },
      { value:'neon', label:'Neon Glow', tier:'rare', preview:'Neon Text' },
      { value:'diamond-shine', label:'Diamond Shine', tier:'legendary', preview:'üíé Shimmering' },
      { value:'cosmic-energy', label:'Cosmic Energy', tier:'eternal', preview:'üåå Cosmic' },
      { value:'starlight-flare', label:'Starlight Flare (MYTHIC)', tier:'mythic', preview:'‚ú® Mythic Flare Text' },
      { value:'plasma-core', label:'Plasma Core (MYTHIC)', tier:'mythic', preview:'‚ö° Plasma Energy' },
      { value:'crystal-radiance', label:'Crystal Radiance (MYTHIC)', tier:'mythic', preview:'üíé Crystal Light' },
      { value:'aurora-burst', label:'Aurora Burst (TRANSCENDENT)', tier:'transcendent', preview:'üåå Ultimate Aurora' },
      { value:'divine-script', label:'Divine Script (TRANSCENDENT)', tier:'transcendent', preview:'‚ú®‚òÄÔ∏è Divine Writing' },
      { value:'reality-bender', label:'Reality Bender (TRANSCENDENT)', tier:'transcendent', preview:'üåÄüí´ Reality Shift' },
      { value:'solar-corona', label:'Solar Corona (SUPREME)', tier:'supreme', preview:'‚òÄÔ∏èüî• Stellar Ink' },
      { value:'luminous-aether', label:'Luminous Aether (SUPREME)', tier:'supreme', preview:'‚ú®ü™ê Aether Text' },
      { value:'omniversal-script', label:'Omniversal Script (ASCENDED)', tier:'ascended', preview:'üìñ‚ú® Beyond Words' },
      { value:'void-tongue', label:'Void Tongue (ASCENDED)', tier:'ascended', preview:'üåëüí¨ Speaks Darkness' }
    ],
    animatedNameEffects: [
      { value:'rainbow-wave', label:'Rainbow Wave', tier:'rare', preview:'üåà Wave' },
      { value:'shimmer', label:'Shimmer', tier:'rare', preview:'‚ú® Shimmer' },
      { value:'phoenix-blaze', label:'Phoenix Blaze', tier:'legendary', preview:'üî• Phoenix' },
      { value:'void-pulse', label:'Void Pulse', tier:'eternal', preview:'üåÄ Void Energy' },
      { value:'stardust-flow', label:'Stardust Flow (MYTHIC)', tier:'mythic', preview:'ü™ê Mythic Stardust' },
      { value:'cosmic-storm', label:'Cosmic Storm (MYTHIC)', tier:'mythic', preview:'‚ö°üåå Storm Effect' },
      { value:'crystal-cascade', label:'Crystal Cascade (MYTHIC)', tier:'mythic', preview:'üíé Crystal Rain' },
      { value:'time-warp', label:'Time Warp (TRANSCENDENT)', tier:'transcendent', preview:'‚è≥ Ultimate Time Distortion' },
      { value:'dimension-rift', label:'Dimension Rift (TRANSCENDENT)', tier:'transcendent', preview:'üåÄ‚ú® Reality Tear' },
      { value:'infinity-spiral', label:'Infinity Spiral (TRANSCENDENT)', tier:'transcendent', preview:'‚ôæÔ∏è Infinite Loop' },
      { value:'quantum-flare', label:'Quantum Flare (SUPREME)', tier:'supreme', preview:'‚öõÔ∏èüî• Quantum Burst' },
      { value:'stellar-rune', label:'Stellar Rune (SUPREME)', tier:'supreme', preview:'üåüüîÆ Arcane Light' },
      { value:'chaos-vortex', label:'Chaos Vortex (ASCENDED)', tier:'ascended', preview:'üå™Ô∏èüí• Universe Collapses' },
      { value:'cosmic-tear', label:'Cosmic Tear (ASCENDED)', tier:'ascended', preview:'üîìüåå Fabric Rips Open' }
    ],
    animatedBorders: [
      { value:'pulse-glow', label:'Pulsing Glow', tier:'rare', preview:'üåü Pulse' },
      { value:'rainbow-spin', label:'Rainbow Spin', tier:'rare', preview:'üé® Spin' },
      { value:'lightning-strike', label:'Lightning Strike', tier:'legendary', preview:'‚ö° Lightning' },
      { value:'quantum-field', label:'Quantum Field', tier:'eternal', preview:'‚öõÔ∏è Quantum' },
      { value:'nebula-surge', label:'Nebula Surge (MYTHIC)', tier:'mythic', preview:'üåå Mythic Nebula Wave' },
      { value:'plasma-ring', label:'Plasma Ring (MYTHIC)', tier:'mythic', preview:'‚ö°üí´ Plasma Circle' },
      { value:'crystal-orbit', label:'Crystal Orbit (MYTHIC)', tier:'mythic', preview:'üíé Crystal Rotation' },
      { value:'singularity', label:'Singularity (TRANSCENDENT)', tier:'transcendent', preview:'üï≥Ô∏è Black Hole Collapse' },
      { value:'supernova', label:'Supernova (TRANSCENDENT)', tier:'transcendent', preview:'üí•üåü Star Explosion' },
      { value:'universe-edge', label:'Universe Edge (TRANSCENDENT)', tier:'transcendent', preview:'üåå‚ú® Cosmic Boundary' },
      { value:'event-horizon', label:'Event Horizon (SUPREME)', tier:'supreme', preview:'üåÄüõ°Ô∏è Light-Bending Shield' },
      { value:'aurora-blade', label:'Aurora Blade (SUPREME)', tier:'supreme', preview:'üåà‚öîÔ∏è Radiant Edge' },
      { value:'paradox-shield', label:'Paradox Shield (ASCENDED)', tier:'ascended', preview:'üîÄüõ°Ô∏è Impossible Protection' },
      { value:'eternity-wall', label:'Eternity Wall (ASCENDED)', tier:'ascended', preview:'‚ôæÔ∏èüß± Timeless Fortress' }
    ],
    titleEffects: [
      { value:'crown', label:'Crown', tier:'rare', preview:'üëë Royal' },
      { value:'halo', label:'Halo', tier:'rare', preview:'‚≠ê Holy' },
      { value:'emperor-crown', label:'Emperor Crown', tier:'legendary', preview:'üëë‚ú® Emperor' },
      { value:'god-mode', label:'God Mode', tier:'eternal', preview:'‚òÄÔ∏è Divine' },
      { value:'sacred-sigil', label:'Sacred Sigil (MYTHIC)', tier:'mythic', preview:'üî± Mythic Sacred Mark' },
      { value:'titan-helm', label:'Titan Helm (MYTHIC)', tier:'mythic', preview:'‚öîÔ∏è Titan Warrior' },
      { value:'oracle-vision', label:'Oracle Vision (MYTHIC)', tier:'mythic', preview:'üëÅÔ∏è All-Seeing' },
      { value:'celestial-ring', label:'Celestial Ring (TRANSCENDENT)', tier:'transcendent', preview:'ü™ê Planetary Crown' },
      { value:'omniscient', label:'Omniscient (TRANSCENDENT)', tier:'transcendent', preview:'‚ú®üëÅÔ∏è‚ú® All-Knowing' },
      { value:'reality-weaver', label:'Reality Weaver (TRANSCENDENT)', tier:'transcendent', preview:'üåÄüí´ Reality Creator' },
      { value:'omni-throne', label:'Omni Throne (SUPREME)', tier:'supreme', preview:'üëëüåå Throne of Realms' },
      { value:'crown-of-light', label:'Crown of Light (SUPREME)', tier:'supreme', preview:'üí°üëë Radiant Sovereign' },
      { value:'absolute-sovereign', label:'Absolute Sovereign (ASCENDED)', tier:'ascended', preview:'üëëüíé Ruler of All Worlds' },
      { value:'apex-divinity', label:'Apex Divinity (ASCENDED)', tier:'ascended', preview:'‚ú®üëÅÔ∏è Beyond Gods' }
    ],
    chatColors: [
      { value:'#60a5fa', label:'Sky Blue', tier:'rare', preview:'#60a5fa' },
      { value:'#f59e0b', label:'Amber', tier:'rare', preview:'#f59e0b' },
      { value:'#34d399', label:'Emerald', tier:'rare', preview:'#34d399' },
      { value:'#ec4899', label:'Pink', tier:'rare', preview:'#ec4899' },
      { value:'#fbbf24', label:'Legendary Gold', tier:'legendary', preview:'#fbbf24' },
      { value:'#a78bfa', label:'Eternal Purple', tier:'eternal', preview:'#a78bfa' },
      { value:'#22d3ee', label:'Mythic Cyan (MYTHIC)', tier:'mythic', preview:'#22d3ee' },
      { value:'#06b6d4', label:'Mythic Teal (MYTHIC)', tier:'mythic', preview:'#06b6d4' },
      { value:'#0891b2', label:'Mythic Deep Cyan (MYTHIC)', tier:'mythic', preview:'#0891b2' },
      { value:'#7c3aed', label:'Transcendent Violet (TRANSCENDENT)', tier:'transcendent', preview:'#7c3aed' },
      { value:'#5b21b6', label:'Transcendent Deep Purple (TRANSCENDENT)', tier:'transcendent', preview:'#5b21b6' },
      { value:'#4c1d95', label:'Transcendent Ultra Violet (TRANSCENDENT)', tier:'transcendent', preview:'#4c1d95' },
      { value:'#ff6b9d', label:'Supreme Roseflare (SUPREME)', tier:'supreme', preview:'#ff6b9d' },
      { value:'#12fff7', label:'Supreme Neon Frost (SUPREME)', tier:'supreme', preview:'#12fff7' },
      { value:'#ff00ff', label:'Ascended Magenta (ASCENDED)', tier:'ascended', preview:'#ff00ff' },
      { value:'#00ffff', label:'Ascended Cyan (ASCENDED)', tier:'ascended', preview:'#00ffff' }
    ],
    backgrounds: [
      { value:'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1200', label:'Aurora', tier:'rare' },
      { value:'https://images.unsplash.com/photo-1502082553048-f009c37129b9?q=80&w=1200', label:'Mountains', tier:'rare' },
      { value:'https://images.unsplash.com/photo-1419242902214-272b3f66ee7a?q=80&w=1200', label:'Starfield', tier:'legendary' },
      { value:'https://images.unsplash.com/photo-1462331940025-496dfbfc7564?q=80&w=1200', label:'Cosmic Realm', tier:'eternal' },
      { value:'https://images.unsplash.com/photo-1517694712202-14dd9538aa97?q=80&w=1200', label:'Mythic Horizon (MYTHIC)', tier:'mythic' },
      { value:'https://images.unsplash.com/photo-1464802686167-b939a6910659?q=80&w=1200', label:'Mythic Storm (MYTHIC)', tier:'mythic' },
      { value:'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?q=80&w=1200', label:'Mythic Peaks (MYTHIC)', tier:'mythic' },
      { value:'https://images.unsplash.com/photo-1446776811953-b23d57bd21aa?q=80&w=1200', label:'Transcendent Cosmos (TRANSCENDENT)', tier:'transcendent' },
      { value:'https://images.unsplash.com/photo-1484589065579-248aad0d8b13?q=80&w=1200', label:'Transcendent Void (TRANSCENDENT)', tier:'transcendent' },
      { value:'https://images.unsplash.com/photo-1545243424-0ce743321e11?q=80&w=1200', label:'Transcendent Dimension (TRANSCENDENT)', tier:'transcendent' },
      { value:'https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?q=80&w=1200', label:'Supreme Aurora Crown (SUPREME)', tier:'supreme' },
      { value:'https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=1200', label:'Supreme Stellar Gate (SUPREME)', tier:'supreme' },
      { value:'https://images.unsplash.com/photo-1419242902214-272b3f66ee7a?q=80&w=1200', label:'Ascended Genesis (ASCENDED)', tier:'ascended' },
      { value:'https://images.unsplash.com/photo-1462331940025-496dfbfc7564?q=80&w=1200', label:'Ascended Infinity (ASCENDED)', tier:'ascended' }
    ],
    virtualPets: [
      { value:'dragon-pet', label:'Dragon Companion (SUPREME)', tier:'supreme', preview:'üêâ Majestic Dragon', price: 9999 },
      { value:'phoenix-pet', label:'Phoenix Ally (SUPREME)', tier:'supreme', preview:'üî•üê¶ Eternal Phoenix', price: 9999 },
      { value:'unicorn-pet', label:'Unicorn Spirit (SUPREME)', tier:'supreme', preview:'ü¶Ñ Mythical Unicorn', price: 9999 },
      { value:'wolf-pet', label:'Shadow Wolf (SUPREME)', tier:'supreme', preview:'üê∫ Dark Guardian', price: 9999 },
      { value:'fairy-pet', label:'Magic Fairy (SUPREME)', tier:'supreme', preview:'üßö Ethereal Fairy', price: 9999 },
      { value:'godling-pet', label:'Godling (ASCENDED)', tier:'ascended', preview:'‚≠êüë∂ Divine Child', price: 19999 },
      { value:'leviathan-pet', label:'Leviathan (ASCENDED)', tier:'ascended', preview:'üêãüåä Primordial Beast', price: 19999 },
      { value:'sentinel-pet', label:'Sentinel (ASCENDED)', tier:'ascended', preview:'ü§ñüí´ Void Guardian', price: 19999 },
      { value:'chimera-pet', label:'Chimera (ASCENDED)', tier:'ascended', preview:'ü¶Åüêâü¶Ö Tri-Beast', price: 19999 },
      { value:'reaper-pet', label:'Grim Reaper (ASCENDED)', tier:'ascended', preview:'üíÄ‚ö∞Ô∏è Death Eternal', price: 19999 }
    ]
  };

  function openCosmeticsModal() {
    if (!systemFeatures.cosmetics) {
      alert('üö´ Cosmetics feature is currently disabled by administrators.');
      return;
    }
    document.getElementById('cosmeticsModal').classList.add('active');
    renderCosmetics();
  }

  function closeCosmeticsModal() {
    document.getElementById('cosmeticsModal').classList.remove('active');
  }

  function openShopModal() {
    if (!systemFeatures.shop) {
      alert('üö´ Shop feature is currently disabled by administrators.');
      return;
    }
    document.getElementById('shopModal').classList.add('active');
    renderShop();
  }

  function closeShopModal() {
    document.getElementById('shopModal').classList.remove('active');
  }

  function renderShop() {
    const container = document.getElementById('shopContainer');
    const balanceEl = document.getElementById('shopBalance');
    if (!container || !balanceEl) return;
    
    const hc = currentProfile?.hc || 0;
    balanceEl.textContent = `${hc.toLocaleString()} ‚ö°`;
    
    let html = '';
    
    // Only display virtualPets in shop
    if (COSMETICS_CATALOG.virtualPets) {
      html += `<h3 style="margin:20px 0 10px; color:#93c5fd;">üêæ Virtual Pets</h3><div class="cosmetic-grid">`;
      
      COSMETICS_CATALOG.virtualPets.forEach(item => {
        const unlocked = isUnlockedCosmetic('virtualPets', item.value);
        const tierClass = item.tier || 'supreme';
        const tierBadge = `<span class="tier-badge ${tierClass}">${item.tier}</span>`;
        
        html += `
          <div class="cosmetic-card ${tierClass}">
            ${unlocked ? '<div class="lock-overlay" style="background:rgba(34,211,238,0.9); color:#000;">‚úÖ Owned</div>' : ''}
            <h4>${item.label} ${tierBadge}</h4>
            <div class="cosmetic-preview" style="font-size:64px;">${item.preview || item.label}</div>
            <div style="margin:10px 0; color:#22d3ee; font-weight:600; font-size:16px;">‚ö° ${item.price.toLocaleString()} ‚ö°</div>
            ${unlocked 
              ? '<button class="equip-btn" style="background:#34d399; color:#000;" disabled>‚úÖ Purchased</button>'
              : `<button class="equip-btn" style="background:#22d3ee; color:#000;" onclick="buyCosmeticShop('virtualPets', '${item.value}', ${item.price})">‚ö° Purchase</button>`
            }
          </div>
        `;
      });
      
      html += '</div>';
    }
    
    if (!html) {
      html = '<p style="text-align:center; color:rgba(255,255,255,0.6); padding:40px;">No items available in shop</p>';
    }
    
    container.innerHTML = html;
  }

  function isUnlockedCosmetic(type, value) {
    if (!currentProfile || !currentProfile.settings) return false;
    const unlocked = currentProfile.settings.unlocked || {};
    const list = unlocked[type] || [];
    return Array.isArray(list) && list.includes(value);
  }

  function currentEquippedCosmetic(type) {
    if (!currentProfile || !currentProfile.settings) return null;
    const cos = currentProfile.settings.cosmetics || {};
    if (type === 'avatarBorders') return cos.avatarBorder || null;
    if (type === 'nameStyles') return cos.nameStyle || null;
    if (type === 'animatedNameEffects') return cos.animatedNameEffect || null;
    if (type === 'animatedBorders') return cos.animatedBorder || null;
    if (type === 'titleEffects') return cos.titleEffect || null;
    if (type === 'chatColors') return cos.chatColor || cos.chatBubbleColor || null;
    if (type === 'backgrounds') return cos.backgroundUrl || null;
    return null;
  }

  async function equipCosmeticItem(type, value) {
    const body = { cosmetics: {} };
    if (type === 'avatarBorders') body.cosmetics.avatarBorder = value;
    else if (type === 'nameStyles') body.cosmetics.nameStyle = value;
    else if (type === 'animatedNameEffects') body.cosmetics.animatedNameEffect = value;
    else if (type === 'animatedBorders') body.cosmetics.animatedBorder = value;
    else if (type === 'titleEffects') body.cosmetics.titleEffect = value;
    else if (type === 'chatColors') { body.cosmetics.chatColor = value; body.cosmetics.chatBubbleColor = value; }
    else if (type === 'backgrounds') body.cosmetics.backgroundUrl = value;
    else if (type === 'virtualPets') body.cosmetics.virtualPet = value;

    try {
      const res = await fetch(`${API}/api/me/settings`, { method:'PATCH', headers: authHeaders(), credentials:'include', body: JSON.stringify(body) });
      if (!res.ok) throw new Error('Failed to equip');
      const data = await res.json();
      currentProfile = data;
      renderCosmetics();
      applyCosmetics(currentProfile.settings);
      if (type === 'virtualPets') {
        loadAndDisplayPet(currentProfile.settings);
      }
      alert('‚úÖ Cosmetic equipped!');
    } catch (e) {
      alert('‚ùå Failed to equip cosmetic');
      console.error(e);
    }
  }

  function renderCosmetics() {
    const container = document.getElementById('cosmeticsContainer');
    let html = '';

    for (const [type, items] of Object.entries(COSMETICS_CATALOG)) {
      // Exclude virtualPets from cosmetics modal (they're in shop now)
      if (type === 'virtualPets') continue;
      
      const typeLabel = type.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
      html += `<h3 style="margin:20px 0 10px; color:#93c5fd;">${typeLabel}</h3><div class="cosmetic-grid">`;

      items.forEach(item => {
        const unlocked = isUnlockedCosmetic(type, item.value);
        const equipped = currentEquippedCosmetic(type) === item.value;
        const tierClass = item.tier || 'rare';
        const tierBadge = `<span class="tier-badge ${tierClass}">${item.tier}</span>`;

        html += `
          <div class="cosmetic-card ${tierClass} ${equipped ? 'equipped' : ''}">
            ${!unlocked ? '<div class="lock-overlay">üîí</div>' : ''}
            <h4>${item.label} ${tierBadge}</h4>
            <div class="cosmetic-preview">${item.preview || item.label}</div>
            <button class="equip-btn ${equipped ? 'equipped' : ''}" 
                    onclick="equipCosmeticItem('${type}', '${item.value}')" 
                    ${!unlocked || equipped ? 'disabled' : ''}>
              ${equipped ? '‚úÖ Equipped' : (unlocked ? 'Equip' : 'üîí Locked')}
            </button>
            ${unlocked && !equipped ? `<button class="equip-btn" style="background:#f87171; margin-top:6px;" onclick="removeCosmeticItem('${type}')">Remove</button>` : ''}
          </div>
        `;
      });

      html += '</div>';
    }

    container.innerHTML = html;
  }

  async function buyCosmeticShop(type, value, price) {
    try {
        // Prevent re-purchase of already owned items
        if (isUnlockedCosmetic(type, value)) {
          alert('‚ùå You already own this item!');
          return;
        }
      
      // Ensure CSRF token is loaded
      if (!isCSRFLoaded) {
        await loadCSRF();
      }
      
      const res = await fetch(`${API}/api/shop/buy`, { 
        method:'POST', 
        headers: authHeaders(), 
        credentials:'include',
        body: JSON.stringify({ type, value, price })
      });
      if (!res.ok) {
        const err = await res.json();
        alert('‚ùå ' + (err.error || 'Purchase failed'));
        return;
      }
      const data = await res.json();
      // Re-fetch profile to get latest data from server
      await fetchProfile();
      renderShop();
      renderCosmetics();
      renderAchievements(currentProfile);
      alert(`‚úÖ ${data.message}`);
    } catch (e) {
      alert('‚ùå Failed to purchase cosmetic');
      console.error(e);
    }
  }

  async function removeCosmeticItem(type) {
    try {
      const res = await fetch(`${API}/api/me/cosmetic/remove`, { 
        method:'POST', 
        headers: authHeaders(), 
        credentials:'include',
        body: JSON.stringify({ type })
      });
      if (!res.ok) throw new Error('Failed to remove');
      const data = await res.json();
      currentProfile.settings.cosmetics = data.cosmetics;
      renderCosmetics();
      applyCosmetics(currentProfile.settings);
      alert('‚úÖ Cosmetic removed!');
    } catch (e) {
      alert('‚ùå Failed to remove cosmetic');
      console.error(e);
    }
  }

  // Settings button click handler
  document.getElementById('settingsBtn').addEventListener('click', openCosmeticsModal);
                             </script>
              
</body>
</html>
