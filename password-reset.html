<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Password Reset - Nandha Chatbot</title>
<script src="config.js"></script>
<style>
  body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    color: #fff;
  }
  
  .container {
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(12px);
    border-radius: 20px;
    padding: 40px;
    width: 100%;
    max-width: 480px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.2);
  }
  
  h1 {
    margin: 0 0 10px 0;
    font-size: 28px;
    text-align: center;
  }
  
  .subtitle {
    text-align: center;
    opacity: 0.9;
    margin-bottom: 30px;
    font-size: 14px;
  }
  
  .step {
    display: none;
    animation: fadeIn 0.4s ease;
  }
  
  .step.active {
    display: block;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  input, button {
    width: 100%;
    padding: 14px;
    margin: 10px 0;
    border-radius: 12px;
    border: none;
    font-size: 15px;
    font-family: inherit;
  }
  
  input {
    background: rgba(255,255,255,0.9);
    color: #333;
  }
  
  input::placeholder {
    color: #999;
  }
  
  button {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    font-weight: 700;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    box-shadow: 0 8px 20px rgba(102,126,234,0.4);
  }
  
  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 28px rgba(102,126,234,0.5);
  }
  
  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }
  
  .otp-display {
    background: rgba(255,255,255,0.25);
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    margin: 20px 0;
    border: 2px dashed rgba(255,255,255,0.4);
  }
  
  .otp-code {
    font-size: 36px;
    font-weight: 700;
    letter-spacing: 8px;
    color: #fff;
    margin: 10px 0;
    text-shadow: 0 2px 10px rgba(0,0,0,0.3);
  }
  
  .error {
    background: rgba(244,67,54,0.8);
    padding: 12px;
    border-radius: 10px;
    margin: 10px 0;
    font-size: 14px;
    text-align: center;
  }
  
  .success {
    background: rgba(76,175,80,0.8);
    padding: 12px;
    border-radius: 10px;
    margin: 10px 0;
    font-size: 14px;
    text-align: center;
  }
  
  .info {
    background: rgba(33,150,243,0.6);
    padding: 12px;
    border-radius: 10px;
    margin: 15px 0;
    font-size: 13px;
    text-align: center;
  }
  
  .back-link {
    text-align: center;
    margin-top: 20px;
  }
  
  .back-link a {
    color: #fff;
    text-decoration: none;
    opacity: 0.9;
    transition: opacity 0.2s;
  }
  
  .back-link a:hover {
    opacity: 1;
    text-decoration: underline;
  }
  
  .timer {
    text-align: center;
    font-size: 13px;
    opacity: 0.8;
    margin-top: 10px;
  }
</style>
</head>
<body>

<div class="container">
  <h1>üîê Password Reset</h1>
  <p class="subtitle">Secure password recovery process</p>

  <!-- Step 1: Request OTP -->
  <div id="step1" class="step active">
    <h3>Step 1: Enter Roll Number</h3>
    <div id="error1" class="error" style="display:none;"></div>
    <input type="text" id="rollInput" placeholder="Enter your roll number" />
    <button id="requestOtpBtn">Generate OTP</button>
    <div class="info">
      üí° An OTP will be generated for password reset. You'll need to verify your identity in the next step.
    </div>
  </div>

  <!-- Step 2: Verify Identity -->
  <div id="step2" class="step">
    <h3>Step 2: Verify Your Identity</h3>
    <div id="error2" class="error" style="display:none;"></div>
    <p style="opacity:0.9;font-size:14px;text-align:center;">
      Enter your current password to verify it's you
    </p>
    <input type="password" id="currentPasswordInput" placeholder="Current password" />
    <button id="verifyIdentityBtn">Verify & Show OTP</button>
  </div>

  <!-- Step 3: View OTP -->
  <div id="step3" class="step">
    <h3>Step 3: Your OTP</h3>
    <div class="otp-display">
      <div style="font-size:14px;opacity:0.9;">Your One-Time Password</div>
      <div class="otp-code" id="otpDisplay">------</div>
      <div class="timer" id="otpTimer">Expires in: --:--</div>
    </div>
    <div class="info">
      üìã Copy this OTP and enter it in the next step along with your new password.
    </div>
    <button id="proceedToResetBtn">Proceed to Reset Password</button>
  </div>

  <!-- Step 4: Enter OTP and New Password -->
  <div id="step4" class="step">
    <h3>Step 4: Reset Password</h3>
    <div id="error4" class="error" style="display:none;"></div>
    <div id="success4" class="success" style="display:none;"></div>
    <input type="text" id="otpInput" placeholder="Enter OTP from previous step" maxlength="6" />
    <input type="password" id="newPasswordInput" placeholder="New password (min 8 characters)" />
    <input type="password" id="confirmPasswordInput" placeholder="Confirm new password" />
    <button id="resetPasswordBtn">Reset Password</button>
    <div class="info">
      üîí Make sure your password is strong: at least 8 characters, include numbers and uppercase letters.
    </div>
  </div>

  <div class="back-link">
    <a href="index.html">‚Üê Back to Login</a>
  </div>
</div>

<script>
const API = window.location.origin;
let currentRoll = '';
let otpExpiresAt = null;
let timerInterval = null;

// Step navigation
function showStep(stepNumber) {
  document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
  document.getElementById(`step${stepNumber}`).classList.add('active');
}

function showError(stepNumber, message) {
  const errorEl = document.getElementById(`error${stepNumber}`);
  errorEl.textContent = message;
  errorEl.style.display = 'block';
  setTimeout(() => errorEl.style.display = 'none', 5000);
}

function showSuccess(stepNumber, message) {
  const successEl = document.getElementById(`success${stepNumber}`);
  successEl.textContent = message;
  successEl.style.display = 'block';
}

// Timer countdown
function startOTPTimer(expiresAt) {
  if (timerInterval) clearInterval(timerInterval);
  
  otpExpiresAt = new Date(expiresAt);
  
  timerInterval = setInterval(() => {
    const now = new Date();
    const diff = otpExpiresAt - now;
    
    if (diff <= 0) {
      clearInterval(timerInterval);
      document.getElementById('otpTimer').textContent = 'OTP Expired!';
      document.getElementById('otpTimer').style.color = '#f44336';
      return;
    }
    
    const minutes = Math.floor(diff / 60000);
    const seconds = Math.floor((diff % 60000) / 1000);
    document.getElementById('otpTimer').textContent = `Expires in: ${minutes}:${seconds.toString().padStart(2, '0')}`;
  }, 1000);
}

// Step 1: Request OTP
document.getElementById('requestOtpBtn').addEventListener('click', async () => {
  const roll = document.getElementById('rollInput').value.trim();
  if (!roll) {
    showError(1, 'Please enter your roll number');
    return;
  }
  
  currentRoll = roll;
  
  try {
    const res = await fetch(`${API}/api/auth/password-reset/request`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ roll })
    });
    
    const data = await res.json();
    
    if (!res.ok) {
      showError(1, data.error || 'Failed to generate OTP');
      return;
    }
    
    showStep(2);
  } catch (err) {
    showError(1, 'Network error. Please try again.');
    console.error(err);
  }
});

// Step 2: Verify Identity
document.getElementById('verifyIdentityBtn').addEventListener('click', async () => {
  const currentPassword = document.getElementById('currentPasswordInput').value;
  
  if (!currentPassword) {
    showError(2, 'Please enter your current password');
    return;
  }
  
  try {
    const res = await fetch(`${API}/api/auth/password-reset/verify-identity`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ roll: currentRoll, currentPassword })
    });
    
    const data = await res.json();
    
    if (!res.ok) {
      showError(2, data.error || 'Identity verification failed');
      return;
    }
    
    // Display OTP
    document.getElementById('otpDisplay').textContent = data.otp;
    startOTPTimer(data.expiresAt);
    
    showStep(3);
  } catch (err) {
    showError(2, 'Network error. Please try again.');
    console.error(err);
  }
});

// Step 3: Proceed to reset
document.getElementById('proceedToResetBtn').addEventListener('click', () => {
  showStep(4);
});

// Step 4: Reset Password
document.getElementById('resetPasswordBtn').addEventListener('click', async () => {
  const otp = document.getElementById('otpInput').value.trim();
  const newPassword = document.getElementById('newPasswordInput').value;
  const confirmPassword = document.getElementById('confirmPasswordInput').value;
  
  if (!otp || !newPassword || !confirmPassword) {
    showError(4, 'All fields are required');
    return;
  }
  
  if (newPassword !== confirmPassword) {
    showError(4, 'Passwords do not match');
    return;
  }
  
  if (newPassword.length < 8) {
    showError(4, 'Password must be at least 8 characters');
    return;
  }
  
  try {
    const res = await fetch(`${API}/api/auth/password-reset/complete`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ roll: currentRoll, otp, newPassword })
    });
    
    const data = await res.json();
    
    if (!res.ok) {
      showError(4, data.error || 'Password reset failed');
      return;
    }
    
    showSuccess(4, '‚úÖ Password reset successful! Redirecting to login...');
    
    setTimeout(() => {
      window.location.href = 'index.html';
    }, 2000);
  } catch (err) {
    showError(4, 'Network error. Please try again.');
    console.error(err);
  }
});
</script>

</body>
</html>
