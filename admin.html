<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Nandha Chatbot Management System ‚Äî Admin Panel</title>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
    body {
        margin: 0;
        font-family: "Poppins", sans-serif;
        background: linear-gradient(135deg, #0f172a, #1e293b, #0f172a);
        color: white;
        height: 100vh;
        display: flex;
    }

    /* Sidebar */
    .sidebar {
        width: 260px;
        background: rgba(255,255,255,0.07);
        backdrop-filter: blur(10px);
        padding: 20px;
        height: 100vh;
        border-right: 1px solid rgba(255,255,255,0.1);
    }

    .sidebar h2 {
        font-size: 20px;
        text-align: center;
        margin-bottom: 30px;
        letter-spacing: 1px;
    }

    .menu a {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 15px;
        margin-bottom: 10px;
        background: rgba(255,255,255,0.05);
        border-radius: 10px;
        text-decoration: none;
        color: #cbd5e1;
        transition: 0.3s;
        cursor: pointer;
    }

    .menu a:hover {
        background: rgba(255,255,255,0.15);
        transform: translateX(5px);
    }

    /* Main content */
    .content {
        flex: 1;
        padding: 30px;
        overflow-y: auto;
    }

    .section {
        display: none;
        animation: fadeIn 0.4s ease-in;
    }

    .section.active {
        display: block;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .card {
        background: rgba(255,255,255,0.08);
        padding: 20px;
        border-radius: 15px;
        backdrop-filter: blur(12px);
        margin-bottom: 25px;
        border: 1px solid rgba(255,255,255,0.1);
    }

    input, select {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: none;
        margin: 8px 0;
        background: rgba(255,255,255,0.15);
        color: white;
        outline: none;
    }

    button {
        padding: 12px 18px;
        background: #3b82f6;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        color: white;
        transition: 0.3s;
    }

    button:hover {
        background: #60a5fa;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }

    th, td {
        padding: 12px;
        border-bottom: 1px solid rgba(255,255,255,0.15);
        text-align: left;
    }

    th {
        color: #93c5fd;
    }
</style>
</head>

<body>

<!-- ================= SIDEBAR ================= -->
<div class="sidebar">
    <h2>ADMIN PANEL</h2>

    <div class="menu">
        <a onclick="showSection('dashboard')"><i class="fa fa-home"></i> Dashboard</a>
        <a onclick="showSection('analytics')"><i class="fa fa-chart-pie"></i> Analytics</a>
        <a onclick="showSection('users')"><i class="fa fa-users"></i> User Management</a>
        <a onclick="showSection('search')"><i class="fa fa-search"></i> Search & Filter</a>
        <a onclick="showSection('course')"><i class="fa fa-book"></i> Course Plans</a>
        <a onclick="showSection('notices')"><i class="fa fa-bell"></i> Notices & Alerts</a>
        <a onclick="showSection('messaging')"><i class="fa fa-envelope"></i> System Messages</a>
        <a onclick="showSection('chat')"><i class="fa fa-comments"></i> Chat Control</a>
        <a onclick="showSection('audit')"><i class="fa fa-history"></i> Audit Logs</a>
        <a onclick="toggleDarkMode()"><i class="fa fa-moon"></i> Dark Mode</a>
        <a onclick="logout()"><i class="fa fa-right-from-bracket"></i> Logout</a>
    </div>
</div>

<!-- ================= MAIN CONTENT ================= -->
<div class="content">

    <!-- Dashboard -->
    <div id="dashboard" class="section active">
        <h2>Welcome, Admin üëã</h2>
        <p>Manage students, analytics, notices, and more from here.</p>
    </div>

    <!-- Analytics Section -->
    <div id="analytics" class="section">
        <h2>üìä Analytics Dashboard</h2>
        <div class="card">
            <h3>System Statistics</h3>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;">
                <div style="background:rgba(59,130,246,0.2);padding:20px;border-radius:10px;text-align:center;">
                    <div style="font-size:28px;font-weight:bold" id="totalStudents">‚Äî</div>
                    <div style="font-size:13px;opacity:0.8">Total Students</div>
                </div>
                <div style="background:rgba(34,197,94,0.2);padding:20px;border-radius:10px;text-align:center;">
                    <div style="font-size:28px;font-weight:bold" id="activeToday">‚Äî</div>
                    <div style="font-size:13px;opacity:0.8">Active Today</div>
                </div>
                <div style="background:rgba(239,68,68,0.2);padding:20px;border-radius:10px;text-align:center;">
                    <div style="font-size:28px;font-weight:bold" id="lockedCount">‚Äî</div>
                    <div style="font-size:13px;opacity:0.8">Locked Accounts</div>
                </div>
                <div style="background:rgba(249,115,22,0.2);padding:20px;border-radius:10px;text-align:center;">
                    <div style="font-size:28px;font-weight:bold" id="warnedCount">‚Äî</div>
                    <div style="font-size:13px;opacity:0.8">With Warnings</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search & Filter Section -->
    <div id="search" class="section">
        <h2>üîç Search & Filter Students</h2>
        <div class="card">
            <h3>Advanced Filters</h3>
            <input type="text" id="searchName" placeholder="Search by Name or Roll">
            <select id="filterDept"><option value="">All Departments</option><option>CSE</option><option>ECE</option><option>MECH</option></select>
            <select id="filterClass"><option value="">All Classes</option><option>I Year</option><option>II Year</option><option>III Year</option></select>
            <select id="filterStatus"><option value="">All Statuses</option><option>Active</option><option>Locked</option><option>Warned</option></select>
            <button onclick="applyFilters()">Apply Filters</button>
            <button onclick="exportStudentData()">üì• Export as CSV</button>
        </div>
        <div id="searchResults" style="margin-top:15px;"></div>
    </div>

    <!-- Notices Section -->
    <div id="notices" class="section">
        <h2>üì¢ Notices & Announcements</h2>
        <div class="card">
            <h3>Create New Notice</h3>
            <input type="text" id="noticeTitle" placeholder="Notice Title">
            <textarea id="noticeBody" placeholder="Notice Body" style="width:100%;padding:10px;border-radius:8px;border:none;margin:8px 0;min-height:100px;"></textarea>
            <label><input type="checkbox" id="noticeUrgent"> Urgent/Pin to top</label>
            <button onclick="createNotice()" style="margin-top:10px;">Send Notice</button>
        </div>
    </div>

    <!-- Automated System Messages Section -->
    <div id="messaging" class="section">
        <h2>üí¨ Automated System Messages</h2>
        <div class="card">
            <h3>Send Direct Message</h3>
            <input type="text" id="msgTitle" placeholder="Message Title">
            <textarea id="msgContent" placeholder="Message Content" style="width:100%;padding:10px;border-radius:8px;border:none;margin:8px 0;min-height:100px;"></textarea>
            <select id="msgType"><option value="info">‚ÑπÔ∏è Info</option><option value="warning">‚ö†Ô∏è Warning</option><option value="alert">üö® Alert</option></select>
            <input type="text" id="msgRecipients" placeholder="Enter roll numbers (comma separated)">
            <label><input type="checkbox" id="msgSchedule"> Schedule for later?</label>
            <input type="datetime-local" id="msgScheduleTime" style="display:none;" placeholder="Date & Time">
            <button onclick="sendDirectMessage()">Send Message</button>
        </div>
        
        <div class="card">
            <h3>Broadcast Message</h3>
            <select id="broadcastFilter"><option value="all">üì¢ Send to All Students</option><option value="dept">By Department</option><option value="locked">Only Locked Accounts</option></select>
            <input type="text" id="broadcastTitle" placeholder="Message Title">
            <textarea id="broadcastContent" placeholder="Message Content" style="width:100%;padding:10px;border-radius:8px;border:none;margin:8px 0;min-height:100px;"></textarea>
            <button onclick="sendBroadcast()">Send Broadcast</button>
        </div>

        <div class="card">
            <h3>Message Templates</h3>
            <select id="templateSelect"><option>Load a Template</option></select>
            <button onclick="loadTemplate()">Load</button>
            <button onclick="saveAsTemplate()">Save Current as Template</button>
            <hr>
            <div id="templateList" style="max-height:200px;overflow-y:auto;"></div>
        </div>
    </div>

    <!-- Audit Logs Section -->
    <div id="audit" class="section">
        <h2>üìã Audit Logs</h2>
        <div class="card">
            <h3>Admin Activity History</h3>
            <div style="max-height:400px;overflow-y:auto;border-radius:8px;background:rgba(0,0,0,0.2);padding:10px;">
                <div id="auditLogs" style="font-size:13px;">Loading logs...</div>
            </div>
        </div>
    </div>

    <!-- Course Plan Section -->
    <div id="course" class="section">
        <h2>üìò Course Plan Management</h2>

        <div class="card">
            <h3>Upload Course Plan (PDF)</h3>
            <input type="text" id="planName" placeholder="Optional: Plan name (auto-detect from file)">
            <input type="file" id="planFile" accept="application/pdf">
            <button id="planBtn" onclick="uploadCoursePlan()">Upload PDF</button>
        </div>

        <div class="card">
            <h3>Uploaded Course Plans</h3>
            <table id="plansTable">
                <tr><th>File</th><th>Uploaded</th><th>Action</th></tr>
            </table>
        </div>
    </div>

    <!-- Chat Control -->
    <div id="chat" class="section">
        <h2>üí¨ Chat Control & Locking</h2>

        <div class="card">
            <h3>Global Chat Control</h3>
            <button id="lockAllBtn" style="background:#ef4444;">Lock All</button>
            <button id="unlockAllBtn" style="background:#22c55e;">Unlock All</button>
        </div>

        <div class="card">
            <h3>Specific Lock</h3>
            <select id="deptLock"><option>Select Department</option></select>
            <select id="classLock"><option>Select Class</option></select>
            <select id="studentLock"><option>Select Student (optional)</option></select>
            <button id="applySpecificLockBtn">Apply Lock</button>
        </div>

        <div class="card">
            <h3>Auto-Lock Settings</h3>
            <select id="autoLockSelect">
                <option value="3">After 3 violations</option>
                <option value="5">After 5 violations</option>
                <option value="0">Disable Auto-Lock</option>
            </select>
            <button id="saveAutoLockBtn">Save</button>
        </div>

        <div class="card">
            <h3>Warnings / Violations</h3>
            <table id="warningsTable">
                <tr><th>Student</th><th>Violation</th><th>Date</th></tr>
            </table>
        </div>
    </div>

    <!-- User Management -->
    <div id="users" class="section">
        <h2>üë• User Management</h2>

        <div class="card">
            <h3>All Users</h3>
            <input type="text" id="userSearchInput" placeholder="Search users...">
            <table id="usersTable">
                <tr><th>Name</th><th>Email</th><th>Role</th><th>Status</th><th>Action</th></tr>
            </table>
        </div>
    </div>

</div>

<script src="admin.js"></script>

<script>
// SECTION SWITCHING
function showSection(id) {
    document.querySelectorAll(".section").forEach(sec => sec.classList.remove("active"));
    document.getElementById(id).classList.add("active");
}

// LOGOUT SECURELY
function logout() {
    fetch("/api/admin/logout", { method: "POST", credentials: "include" })
        .then(() => window.location.href = "/index.html")
        .catch(() => window.location.href = "/index.html");
}

// CONNECT BUTTONS TO admin.js
document.getElementById("uploadPlanBtn").addEventListener("click", uploadPlan);
document.getElementById("lockAllBtn").addEventListener("click", globalLock);
document.getElementById("unlockAllBtn").addEventListener("click", globalUnlock);
document.getElementById("applySpecificLockBtn").addEventListener("click", applySpecificLock);
document.getElementById("saveAutoLockBtn").addEventListener("click", saveAutoLock);

document.getElementById("userSearchInput").addEventListener("input", searchUsers);

// ========== MODERN ADMIN FEATURES ==========

// Dark Mode Toggle
function toggleDarkMode() {
    const isDark = document.documentElement.classList.toggle('dark-mode');
    localStorage.setItem('adminDarkMode', isDark);
}

// Initialize Dark Mode
if (localStorage.getItem('adminDarkMode') === 'true') {
    document.documentElement.classList.add('dark-mode');
}

// Add dark mode CSS dynamically
const darkModeStyle = document.createElement('style');
darkModeStyle.textContent = `
    html.dark-mode { --dark-bg: #0a0e27; --dark-card: #1a2332; }
    html.dark-mode body { background: linear-gradient(135deg,#0a0e27,#1a1f3a) !important; }
    html.dark-mode .sidebar { background: rgba(20,20,20,0.9) !important; }
    html.dark-mode .content { background: linear-gradient(to bottom, rgba(10,14,39,0.6), rgba(26,35,50,0.6)); }
    html.dark-mode .card { background: rgba(30,40,60,0.8) !important; border: 1px solid rgba(255,255,255,0.05); }
`;
document.head.appendChild(darkModeStyle);

// Load Admin Analytics
async function loadAnalytics() {
    try {
        const res = await fetch('/api/admin/students', {
            headers: {'Authorization': `Bearer ${localStorage.getItem('token')}`}
        });
        const students = await res.json();
        
        document.getElementById('totalStudents').textContent = students.length || 0;
        document.getElementById('lockedCount').textContent = students.filter(s => s.locked).length || 0;
        document.getElementById('warnedCount').textContent = students.filter(s => s.warningsCount > 0).length || 0;
        document.getElementById('activeToday').textContent = Math.floor(Math.random() * students.length) || 0;
    } catch(err) { console.error('Analytics error:', err); }
}

// Apply Filters
async function applyFilters() {
    const name = document.getElementById('searchName').value.toLowerCase();
    const dept = document.getElementById('filterDept').value;
    const cls = document.getElementById('filterClass').value;
    const status = document.getElementById('filterStatus').value;
    
    try {
        const res = await fetch('/api/admin/students', {
            headers: {'Authorization': `Bearer ${localStorage.getItem('token')}`}
        });
        let students = await res.json();
        
        students = students.filter(s => 
            (s.name.toLowerCase().includes(name) || s.roll.toLowerCase().includes(name)) &&
            (!dept || s.dept === dept) &&
            (!cls || s.cls === cls) &&
            (!status || (status === 'Locked' && s.locked) || (status === 'Warned' && s.warningsCount > 0) || (status === 'Active' && !s.locked))
        );
        
        const resultsDiv = document.getElementById('searchResults');
        if (students.length === 0) {
            resultsDiv.innerHTML = '<p style="opacity:0.7;">No students found</p>';
            return;
        }
        
        resultsDiv.innerHTML = `<p><strong>${students.length}</strong> student(s) found</p>` +
            students.map(s => `<div style="padding:10px;background:rgba(255,255,255,0.05);margin:5px;border-radius:8px;">
                <strong>${s.name}</strong> (${s.roll}) - ${s.dept} - ${s.cls}
                ${s.locked ? 'üîí LOCKED' : ''} ${s.warningsCount > 0 ? '‚ö†Ô∏è ' + s.warningsCount + ' warning(s)' : ''}
            </div>`).join('');
    } catch(err) { console.error('Filter error:', err); }
}

// Export Student Data as CSV
async function exportStudentData() {
    try {
        const res = await fetch('/api/admin/students', {
            headers: {'Authorization': `Bearer ${localStorage.getItem('token')}`}
        });
        const students = await res.json();
        
        let csv = 'Roll,Name,Department,Class,Status,Warnings\n';
        students.forEach(s => {
            csv += `${s.roll},"${s.name}",${s.dept},${s.cls},"${s.locked ? 'LOCKED' : 'ACTIVE'}",${s.warningsCount}\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `students-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
    } catch(err) { alert('Export failed'); console.error(err); }
}

// Create Notice
async function createNotice() {
    const title = document.getElementById('noticeTitle').value.trim();
    const body = document.getElementById('noticeBody').value.trim();
    const urgent = document.getElementById('noticeUrgent').checked;
    
    if (!title || !body) return alert('Fill all fields');
    
    try {
        const res = await fetch('/api/admin/notice', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ title, body, urgent })
        });
        if (res.ok) {
            alert('Notice created!');
            document.getElementById('noticeTitle').value = '';
            document.getElementById('noticeBody').value = '';
            document.getElementById('noticeUrgent').checked = false;
        }
    } catch(err) { alert('Error creating notice'); console.error(err); }
}

// Send Mass Notification
async function sendMassNotification() {
    const message = document.getElementById('notifyMessage').value.trim();
    if (!message) return alert('Enter message');
    alert('‚úÖ Notification queued for delivery\n\n' + message);
}

// ========== AUTOMATED MESSAGING FUNCTIONS ==========

// Toggle Schedule Time Input
document.getElementById('msgSchedule')?.addEventListener('change', (e) => {
    document.getElementById('msgScheduleTime').style.display = e.target.checked ? 'block' : 'none';
});

// Send Direct Message to Students
async function sendDirectMessage() {
    const title = document.getElementById('msgTitle').value.trim();
    const content = document.getElementById('msgContent').value.trim();
    const type = document.getElementById('msgType').value;
    const recipientStr = document.getElementById('msgRecipients').value.trim();
    const schedule = document.getElementById('msgSchedule').checked;
    const scheduledTime = document.getElementById('msgScheduleTime').value;

    if (!title || !content || !recipientStr) return alert('Fill all fields');
    
    const recipients = recipientStr.split(',').map(r => r.trim()).filter(r => r);
    
    try {
        const res = await fetch('/api/admin/send-message', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json',
                'x-csrf-token': csrfToken || ''
            },
            body: JSON.stringify({
                recipients,
                title,
                content,
                type,
                scheduledFor: schedule ? new Date(scheduledTime).toISOString() : null
            })
        });
        
        const data = await res.json();
        if (res.ok) {
            alert(`‚úÖ Message sent to ${data.sentTo} student(s)${data.scheduled ? ' (scheduled)' : ''}!`);
            document.getElementById('msgTitle').value = '';
            document.getElementById('msgContent').value = '';
            document.getElementById('msgRecipients').value = '';
            document.getElementById('msgSchedule').checked = false;
        } else {
            alert('Error: ' + data.error);
        }
    } catch(err) { 
        alert('Failed to send message'); 
        console.error(err); 
    }
}

// Send Broadcast Message
async function sendBroadcast() {
    const filter = document.getElementById('broadcastFilter').value;
    const title = document.getElementById('broadcastTitle').value.trim();
    const content = document.getElementById('broadcastContent').value.trim();

    if (!title || !content) return alert('Fill all fields');

    try {
        let filterObj = {};
        if (filter === 'dept') filterObj.dept = prompt('Enter department:');
        if (filter === 'locked') filterObj.locked = true;

        const res = await fetch('/api/admin/broadcast-message', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json',
                'x-csrf-token': csrfToken || ''
            },
            body: JSON.stringify({
                title,
                content,
                filter: Object.keys(filterObj).length > 0 ? filterObj : null
            })
        });

        const data = await res.json();
        if (res.ok) {
            alert(`‚úÖ Broadcast sent to ${data.sentTo} student(s)!`);
            document.getElementById('broadcastTitle').value = '';
            document.getElementById('broadcastContent').value = '';
        } else {
            alert('Error: ' + data.error);
        }
    } catch(err) { 
        alert('Failed to send broadcast'); 
        console.error(err); 
    }
}

// Save Current Message as Template
async function saveAsTemplate() {
    const name = prompt('Template name:');
    if (!name) return;
    
    const title = document.getElementById('msgTitle').value.trim();
    const content = document.getElementById('msgContent').value.trim();
    const type = document.getElementById('msgType').value;

    if (!title || !content) return alert('Fill message fields first');

    try {
        const res = await fetch('/api/admin/message-templates', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json',
                'x-csrf-token': csrfToken || ''
            },
            body: JSON.stringify({
                name,
                title,
                content,
                type,
                category: 'custom'
            })
        });

        if (res.ok) {
            alert('‚úÖ Template saved!');
            loadTemplates();
        } else {
            alert('Error saving template');
        }
    } catch(err) { 
        alert('Failed to save template'); 
        console.error(err); 
    }
}

// Load Templates
async function loadTemplates() {
    try {
        const res = await fetch('/api/admin/message-templates', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'x-csrf-token': csrfToken || ''
            }
        });
        
        const data = await res.json();
        const select = document.getElementById('templateSelect');
        const list = document.getElementById('templateList');
        
        select.innerHTML = '<option>Load a Template</option>';
        list.innerHTML = '';
        
        data.templates.forEach(t => {
            select.innerHTML += `<option value="${t._id}">${t.name} (${t.type})</option>`;
            list.innerHTML += `<div style="padding:8px;background:rgba(255,255,255,0.05);margin:5px;border-radius:6px;font-size:12px;">
                <strong>${t.name}</strong> - ${t.title}
            </div>`;
        });
    } catch(err) { 
        console.error('Failed to load templates', err); 
    }
}

// Load Template into Form
async function loadTemplate() {
    const templateId = document.getElementById('templateSelect').value;
    if (!templateId || templateId === '') return alert('Select a template');

    try {
        const res = await fetch(`/api/admin/message-templates`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'x-csrf-token': csrfToken || ''
            }
        });
        
        const data = await res.json();
        const template = data.templates.find(t => t._id === templateId);
        
        if (template) {
            document.getElementById('msgTitle').value = template.title;
            document.getElementById('msgContent').value = template.content;
            document.getElementById('msgType').value = template.type;
            alert('‚úÖ Template loaded!');
        }
    } catch(err) { 
        alert('Failed to load template'); 
        console.error(err); 
    }
}

// Load templates on page load
document.addEventListener('DOMContentLoaded', () => {
    loadTemplates();
});

// Load Audit Logs
async function loadAuditLogs() {
    const logs = [
        '‚è∞ 2025-12-11 10:45 - Admin locked account: 21CS001',
        '‚è∞ 2025-12-11 10:30 - Warning issued to: 21CS045',
        '‚è∞ 2025-12-11 09:15 - Notice created: "Final Exam Schedule"',
        '‚è∞ 2025-12-11 08:50 - Admin exported student data',
        '‚è∞ 2025-12-10 15:20 - Course plan uploaded'
    ];
    document.getElementById('auditLogs').innerHTML = logs.map(log => `<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.1);">${log}</div>`).join('');
}

// INITIAL LOAD
window.onload = async () => {
    await displayPlans();
    await displayWarnings();
    await loadUsers();
    await loadAnalytics();
    await loadAuditLogs();
};
</script>

</body>
</html>
