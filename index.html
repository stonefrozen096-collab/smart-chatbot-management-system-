<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nandha Chatbot Management System</title>
<style>
  body {margin:0;font-family:'Poppins',sans-serif;background:linear-gradient(135deg,#0077ff,#00d4ff);background-size:200% 200%;animation:gradientShift 12s ease-in-out infinite;display:flex;justify-content:center;align-items:center;height:100vh;color:#fff;overflow:hidden;}
  body::before,body::after{content:"";position:absolute;width:260px;height:260px;border-radius:50%;background:rgba(255,255,255,0.12);filter:blur(30px);animation:floaty 9s ease-in-out infinite;}
  body::before{top:-60px;left:-40px;}
  body::after{bottom:-70px;right:-30px;animation-delay:2s;}
  .container{position:relative;z-index:1;background:rgba(255,255,255,0.16);border:1px solid rgba(255,255,255,0.18);box-shadow:0 18px 45px rgba(0,0,0,0.18);border-radius:20px;backdrop-filter:blur(14px);padding:42px 52px;width:340px;text-align:center;animation:popIn 0.8s ease forwards;}
  h1{font-size:27px;font-weight:700;margin-bottom:6px;letter-spacing:0.3px;}
  .tagline{margin-top:0;margin-bottom:18px;opacity:0.9;}
  input,button{width:100%;padding:12px;margin:10px 0;border-radius:10px;border:none;font-size:15px;}
  input{background:rgba(255,255,255,0.94);color:#0d1b2a;}
  button{background:linear-gradient(135deg,#0077ff,#00b3ff);color:white;font-weight:700;cursor:pointer;transition:transform 0.25s ease,box-shadow 0.25s ease;box-shadow:0 10px 25px rgba(0,123,255,0.35);}
  button:hover{transform:translateY(-2px) scale(1.01);box-shadow:0 14px 32px rgba(0,123,255,0.45);}
  .toggle-link{cursor:pointer;text-decoration:underline;opacity:0.9;}
  .error-msg{color:#ffcccb;font-size:13px;min-height:18px;}
  .lock-banner{display:none;margin:10px 0;padding:10px;border-radius:10px;background:rgba(234,179,8,0.2);border:1px solid rgba(234,179,8,0.45);color:#1f2937;font-weight:600;}
  section{display:none;animation:fadeIn 0.4s ease;}
  #loginSection{display:block;}
  @keyframes gradientShift{0%{background-position:0% 50%;}50%{background-position:100% 50%;}100%{background-position:0% 50%;}}
  @keyframes floaty{0%,100%{transform:translateY(0);}50%{transform:translateY(20px);} }
  @keyframes popIn{0%{opacity:0;transform:translateY(18px) scale(0.98);}100%{opacity:1;transform:translateY(0) scale(1);} }
  @keyframes fadeIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);} }
</style>
</head>
<body>
<div class="container">
  <h1>Nandha Chatbot Management System</h1>
  <p class="tagline">Your academic assistant</p>

  <!-- LOGIN -->
  <section id="loginSection">
    <div class="error-msg" id="loginError"></div>
    <div class="lock-banner" id="lockBanner">ðŸ”’ Account locked</div>
    <input type="text" id="loginRoll" placeholder="Roll Number or Admin ID">
    <input type="password" id="loginPassword" placeholder="Password">
    <button id="loginBtn">Login</button>
    <div class="toggle-link" onclick="showSignup()">New user? Signup</div>
  </section>

  <!-- SIGNUP -->
  <section id="signupSection">
    <div class="error-msg" id="signupError"></div>
    <input type="text" id="signupName" placeholder="Full Name">
    <input type="text" id="signupRoll" placeholder="Roll Number">
    <input type="text" id="signupDept" placeholder="Department">
    <input type="text" id="signupClass" placeholder="Class">
    <input type="email" id="signupEmail" placeholder="Email">
    <input type="password" id="signupPassword" placeholder="Password">
    <input type="password" id="signupConfirmPassword" placeholder="Confirm Password">
    <button id="signupBtn">Sign Up</button>
    <div class="toggle-link" onclick="showLogin()">Already have an account? Login</div>
  </section>
</div>

<script>
const API_URL = "https://smart-chatbot-backend-w5tq.onrender.com";
let csrfToken = "";

// CSRF
async function loadCSRF(){
  const r = await fetch(`${API_URL}/api/csrf-token`, {method:"GET",credentials:"include"});
  const d = await r.json();
  csrfToken=d.csrfToken;
}

// Utils
function sanitize(str){return str.replace(/[<>&"']/g,c=>({"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&#39;"}[c]));}
function validEmail(email){return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);}
function strongPassword(pw){return pw.length>=8 && /[0-9]/.test(pw) && /[A-Z]/.test(pw);}
function showSignup(){loginSection.style.display="none";signupSection.style.display="block";}
function showLogin(){signupSection.style.display="none";loginSection.style.display="block";}

// LOGIN
loginBtn.addEventListener("click",async()=>{
  const roll=sanitize(loginRoll.value.trim());
  const password=sanitize(loginPassword.value.trim());
  loginError.textContent="";
  lockBanner.style.display = 'none';
  lockBanner.textContent = 'ðŸ”’ Account locked';
  if(!roll||!password)return loginError.textContent="All fields required!";
  try{
    await loadCSRF();
    const res=await fetch(`${API_URL}/api/auth/login`,{
      method:"POST",credentials:"include",
      headers:{"Content-Type":"application/json","x-csrf-token":csrfToken},
      body:JSON.stringify({roll,password})
    });
    const data=await res.json();
    if(data.error) return loginError.textContent=data.error;

    // store token + user info
    sessionStorage.setItem("token",data.accessToken);
    localStorage.setItem("token",data.accessToken); // persist for student.html
    sessionStorage.setItem("userProfile",JSON.stringify(data.student));

    // verify lock status before redirect
    try {
      const meRes = await fetch(`${API_URL}/api/me`, {
        method: 'GET',
        credentials: 'include',
        headers: { 'Authorization': `Bearer ${data.accessToken}`, 'x-csrf-token': csrfToken }
      });
      const me = await meRes.json();
      if (me && me.lockedUntil) {
        const until = new Date(me.lockedUntil);
        if (until > new Date()) {
          lockBanner.textContent = `ðŸ”’ Account locked until ${until.toLocaleString()}. Please contact admin.`;
          lockBanner.style.display = 'block';
          // Clear tokens so locked users cannot proceed
          localStorage.removeItem('token');
          sessionStorage.removeItem('token');
          // Disable login temporarily
          loginBtn.disabled = true;
          setTimeout(()=>{ loginBtn.disabled = false; }, 2000);
          return;
        }
      }
    } catch (e) { /* ignore and continue */ }

    // redirect
    if(data.student.role==="admin") window.location.href="admin.html";
    else window.location.href="student.html";

  }catch{loginError.textContent="Server error, try later.";}
});

// SIGNUP
signupBtn.addEventListener("click",async()=>{
  const name=sanitize(signupName.value.trim()), roll=sanitize(signupRoll.value.trim()),
  dept=sanitize(signupDept.value.trim()), cls=sanitize(signupClass.value.trim()),
  email=sanitize(signupEmail.value.trim()), password=sanitize(signupPassword.value.trim()),
  confirm=sanitize(signupConfirmPassword.value.trim());
  signupError.textContent="";
  if(!name||!roll||!dept||!cls||!email||!password)return signupError.textContent="All fields required!";
  if(!validEmail(email)) return signupError.textContent="Invalid email!";
  if(!strongPassword(password)) return signupError.textContent="Password must be 8+ chars, include number & uppercase!";
  if(password!==confirm) return signupError.textContent="Passwords do not match!";
  try{
    await loadCSRF();
    const res=await fetch(`${API_URL}/api/auth/register`,{
      method:"POST",credentials:"include",
      headers:{"Content-Type":"application/json","x-csrf-token":csrfToken},
      body:JSON.stringify({name,roll,dept,cls,email,password,role:"student"})
    });
    const data=await res.json();
    if(data.error) return signupError.textContent=data.error;
    alert("Signup successful! Please login."); showLogin();
  }catch{signupError.textContent="Server error, try later.";}
});
</script>
</body>
</html>
